#CrmAsWeekly@Search
--CrmAsWeekly@SearchWITH W_CRM_AS_MSTAS(        SELECT A.MNGT_NO             , A.REQ_YMD             , A.REQ_HM             , M.CD_NM AS REQ_SVC             , K.CD_NM AS REQ_SVC2             , Z.CD_NM AS REQ_TYPE2             , NVL(C.CUST_LOC_NM,C.CUST_NM) AS CUST_NM              , A.PROC_TYPE             , A.CONTENT             , A.RMK             --, A.WORK_USR             , NVL((SELECT Z.LOC_NM FROM CRM_USR_MST Z WHERE Z.USR_ID = A.WORK_USR AND ROWNUM = 1),A.WORK_USR) AS WORK_USR --자료조작후 제거예정             , A.PRAR_YMD             , A.CMPT_YMD             , A.CMPT_HM             , A.SYS_ID AS SYS_NM             , M.OPT_ITEM5 AS REQ_SVC_GRP             , TO_NUMBER(SUBSTR(M.OPT_ITEM5, 1, INSTR(M.OPT_ITEM5,'.')-1)) AS SORT                                    --, (CASE WHEN A.REQ_YMD > '20190215' AND A.PROC_TYPE IN ('7','3','4','5','6') THEN 'Y' ELSE 'N' END) AS PREV_YN             , (CASE WHEN (A.REQ_YMD  >= '@FM_YMD'      AND A.REQ_YMD <= '@TO_YMD'      AND A.PROC_TYPE IN ('7','3','4','5','6')) THEN 'Y'                      WHEN (A.REQ_YMD  >= '@FM_YMD_PREV' AND A.REQ_YMD <= '@TO_YMD_PREV' AND A.PROC_TYPE IN ('7','3','4','5','6')) THEN 'Y'                      ELSE 'N' END) AS PREV_YN          FROM CRM_AS_MST A                 INNER JOIN MDM_COM_CODE M ON M.GRP_CD = 'T02' AND M.COMN_CD = A.REQ_SVC               INNER JOIN MDM_COM_CODE K ON K.GRP_CD = 'T10' AND K.COMN_CD = A.REQ_SVC2               INNER JOIN MDM_COM_CODE Z ON Z.GRP_CD = 'T09' AND Z.COMN_CD = A.REQ_TYPE2               INNER JOIN CRM_CUST_MST C ON C.CUST_CD = A.CUST_CD            WHERE 1 = 1         [DEPT_CD]           AND A.WORK_USR IN (SELECT USR_ID FROM CRM_USR_MST WHERE DEPT_CD = '@DEPT_CD'                              UNION ALL                               SELECT LOC_NM FROM CRM_USR_MST WHERE DEPT_CD = '@DEPT_CD')         [/DEPT_CD]         [THIS_WEEK]           AND (   (A.CMPT_YMD >= '@FM_YMD' AND A.CMPT_YMD <= '@TO_YMD' AND A.PROC_TYPE IN ('1','2')) --기간에 완료된 자료                OR (A.REQ_YMD  >= '@FM_YMD' AND A.REQ_YMD  <= '@TO_YMD' AND A.PROC_TYPE IN ('7','3','4','5','6')) --기간에 미완료된 자료                OR (A.REQ_YMD  >= '@FM_YMD_PREV' AND A.REQ_YMD <= '@TO_YMD_PREV' AND A.PROC_TYPE IN ('7','3','4','5','6')) --기간에 전주 미완료된 자료               )         [/THIS_WEEK]             [NEXT_WEEK]           AND (   A.PRAR_YMD >= '@FM_YMD_NEXT' --AND A.PRAR_YMD <= '@TO_YMD_NEXT' '차차주 자료 조회 하기 위해서 변경                OR A.CMPT_YMD >= '@FM_YMD_NEXT' --AND A.CMPT_YMD <= '@TO_YMD_NEXT'               )         [/NEXT_WEEK]         [PROJECT_CD]           AND A.PROJECT_CD = '@PROJECT_CD'         [/PROJECT_CD])SELECT A.MNGT_NO     , A.REQ_SVC     , A.REQ_SVC2     , A.REQ_TYPE2     , CASE WHEN A.PREV_YN = 'Y' THEN '99.미처리' ELSE A.REQ_SVC_GRP END AS REQ_SVC_GRP     , A.CUST_NM     , '<요청사항> '||REPLACE(REPLACE(SUBSTR(A.CONTENT,1,900),CHR(13),''),CHR(10),' ')||CHR(13)||CHR(10)||'<조치결과> '||REPLACE(REPLACE(SUBSTR(A.RMK,1,900),CHR(13),''),CHR(10),' ') AS CONTENT_RMK     , A.CONTENT     , A.RMK     , A.WORK_USR     , UFN_FORMAT(A.REQ_YMD,'DATE')||' '||UFN_FORMAT(A.REQ_HM,'TIME') AS REQ_DATE     , UFN_FORMAT(A.PRAR_YMD,'DATE') AS PRAR_YMD     , (CASE WHEN A.CMPT_YMD IS NULL THEN UFN_FORMAT(A.PRAR_YMD,'DATE')             ELSE UFN_FORMAT(A.CMPT_YMD,'DATE')||' '||UFN_FORMAT(A.CMPT_HM,'TIME')        END) AS CMPT_DATE     , PROC_TYPE     , (CASE WHEN A.PROC_TYPE IN ('1','2') THEN 100              WHEN A.PROC_TYPE IN ('7') THEN 50             ELSE 0        END) AS PROC_RATE     , 1 AS PIVOT_CNT  FROM W_CRM_AS_MST A ORDER BY A.SORT 
#CrmAsWeekly@SearchDev
--CrmAsWeekly@SearchDevWITH W_CMPTAS(    --완료일자 검색    SELECT A.USR_ID         , B.PROJECT_CD         , UFN_GET_COM_INFO('T16',B.PROJECT_CD) AS PROJECT_NM         , UFN_GET_COM_INFO('Z01',A.REQ_SVC)||'('||COUNT(*)||')' AS REQ_SVC_NM         , NVL(UFN_GET_COM_INFO('Z01',MAX(A.REQ_SVC),'SORT'),'999') AS REQ_SVC_SORT         , MAX(A.PROC_TYPE) AS PROC_TYPE         --, MAX((SELECT MAX(Z.CUST_LOC_NM) FROM CRM_CUST_MST Z WHERE Z.CUST_CD = B.CUST_CD)) AS CUST_LOC_NM          , MAX(C.RANK) AS RANK --난이도         , MAX(CASE WHEN B.PROJECT_CD IS NOT NULL                     THEN   CASE WHEN A.RANK1  = 'Y' THEN '신규(개발),' END                         ||CASE WHEN A.RANK2  = 'Y' THEN '화면변경,' END                         ||CASE WHEN A.RANK3  = 'Y' THEN '로직수정,' END                         ||CASE WHEN A.RANK4  = 'Y' THEN '쿼리수정,' END                         ||CASE WHEN A.RANK5  = 'Y' THEN 'RPT추가,' END                         ||CASE WHEN A.RANK6  = 'Y' THEN 'RPT변경,' END                         ||CASE WHEN A.RANK7  = 'Y' THEN '단순문의,' END                         ||CASE WHEN A.RANK8  = 'Y' THEN 'Data변경,' END                         ||CASE WHEN A.RANK9  = 'Y' THEN 'EDI확인,' END                         ||CASE WHEN A.RANK10 = 'Y' THEN '업무분석,' END                         ||CASE WHEN A.RANK11 = 'Y' THEN '설계,' END                         ||CASE WHEN A.RANK12 = 'Y' THEN '화면디자인,' END                         ||CASE WHEN A.RANK13 = 'Y' THEN '설치,' END                         ||CASE WHEN A.RANK14 = 'Y' THEN '통합테스트,' END                         ||CASE WHEN A.RANK15 = 'Y' THEN '기타,' END                         ||CASE WHEN A.RANK16 = 'Y' THEN 'Data이관,' END                         ||CASE WHEN A.RANK17 = 'Y' THEN '산출물작성,' END               END) AS JOB_CHK_NM --작업항목         , COUNT(*) AS CMPT_CNT         , SUM(UFN_AS_SCORE(A.MNGT_NO)) AS SCORE_SUM          , MAX(A.MNGT_NO) AS MNGT_NO      FROM CRM_AS_MST_WORK A           INNER JOIN CRM_AS_MST B           ON A.MNGT_NO = B.MNGT_NO--           AND NOT B.REQ_SVC2 IN ('UA004') --일일보고 제외           INNER JOIN CRM_USR_MST C           ON A.USR_ID = C.USR_ID AND C.USE_YN = 'Y'     WHERE A.CMPT_YMD >= '@FM_YMD' AND A.CMPT_YMD <= '@TO_YMD'       AND A.SEQ <> 0     [DEV_PIC_CD]       AND A.USR_ID IN ('@DEV_PIC_CD')     [/DEV_PIC_CD]     [DEPT_CD]       AND A.DEPT_CD IN ('@DEPT_CD')     [/DEPT_CD]     [PROJECT_CD]       AND B.PROJECT_CD = '@PROJECT_CD'     [/PROJECT_CD]     GROUP BY A.USR_ID, B.PROJECT_CD, A.REQ_SVC --, A.MNGT_NO) , W_PRAR AS (    SELECT A.USR_ID         , B.PROJECT_CD         , COUNT(*) AS PRAR_CNT      FROM CRM_AS_MST_WORK A           INNER JOIN CRM_AS_MST B           ON A.MNGT_NO = B.MNGT_NO           --AND NOT B.REQ_SVC2 IN ('UA004') --일일보고 제외           INNER JOIN CRM_USR_MST C           ON A.USR_ID = C.USR_ID AND C.USE_YN = 'Y'     WHERE A.PRAR_YMD >= '@FM_YMD_NEXT' AND A.PRAR_YMD <= '@TO_YMD_NEXT'       AND A.CMPT_YMD IS NULL       AND A.SEQ <> 0     [DEV_PIC_CD]       AND A.USR_ID IN ('@DEV_PIC_CD')     [/DEV_PIC_CD]     [DEPT_CD]       AND A.DEPT_CD IN ('@DEPT_CD')     [/DEPT_CD]     [PROJECT_CD]       AND B.PROJECT_CD = '@PROJECT_CD'     [/PROJECT_CD]  GROUP BY A.USR_ID, B.PROJECT_CD), W_JOINAS (    SELECT NVL(A.USR_ID, B.USR_ID) AS USR_ID         , NVL(A.PROJECT_CD, B.PROJECT_CD) AS PROJECT_CD         , NVL((SELECT Z.RANK FROM CRM_USR_MST Z WHERE Z.USR_ID = NVL(A.USR_ID, B.USR_ID)),'Z') AS RANK_SORT         , (CASE WHEN A.USR_ID IS NOT NULL --AND A.PROJECT_CD IS NULL                  THEN (SELECT COUNT(*)                          FROM CRM_AS_MST_WORK Z                               INNER JOIN CRM_AS_MST X                               ON Z.MNGT_NO = X.MNGT_NO                              --AND NOT X.REQ_SVC2 IN ('UA004') --일일보고 제외                         WHERE Z.REQ_YMD >= '@FM_YMD' AND Z.REQ_YMD <= '@TO_YMD'                          AND Z.SEQ <> 0                          AND Z.USR_ID = NVL(A.USR_ID, B.USR_ID)                        [DEPT_CD]                          AND Z.DEPT_CD IN ('@DEPT_CD')                        [/DEPT_CD]                        [PROJECT_CD]                          AND X.PROJECT_CD = '@PROJECT_CD'                        [/PROJECT_CD]                          AND NVL(X.PROJECT_CD,'NULL') = NVL(A.PROJECT_CD,'NULL')                      )                 ELSE 0             END) AS REQ_CNT           , SUM(NVL(A.CMPT_CNT,0)) AS CMPT_CNT         , SUM(NVL(A.SCORE_SUM,0)) AS SCORE_SUM         , (CASE WHEN A.PROJECT_CD IS NULL                 THEN REPLACE(('유지보수 ('||REGEXP_REPLACE(LISTAGG(A.REQ_SVC_NM, ',') WITHIN GROUP(ORDER BY A.REQ_SVC_SORT), '([^,]+)(,\1)*(,|$)', '\1\3')||')'),'유지보수 ()','')                 ELSE REPLACE(MAX(A.PROJECT_NM)||'('||REGEXP_REPLACE(LISTAGG(A.JOB_CHK_NM, '/') WITHIN GROUP(ORDER BY A.JOB_CHK_NM), '([^,]+)(,\1)*(,|$)', '\1\3')||')',',)',')')             END) AS SM_SI_CMPT         , (CASE WHEN B.PROJECT_CD IS NULL                 THEN REPLACE(('유지보수 ([요청내역] 외 '||SUM(NVL(B.PRAR_CNT,0))||'건)'),'유지보수 ([요청내역] 외 0건)','')                 ELSE REPLACE(UFN_GET_COM_INFO('T16',B.PROJECT_CD)||(' ([요청내역] 외 '||SUM(NVL(B.PRAR_CNT,0))||'건)'),'([요청내역] 외 0건)','')            END) AS SM_SI_PRAR      FROM W_CMPT A           FULL JOIN W_PRAR B           ON A.USR_ID = B.USR_ID AND A.PROJECT_CD = B.PROJECT_CD     GROUP BY A.USR_ID, A.PROJECT_CD, B.USR_ID, B.PROJECT_CD)SELECT A.USR_ID      , (SELECT MAX(Z.LOC_NM) FROM CRM_USR_MST Z WHERE Z.USR_ID = A.USR_ID) AS USR_NM      , A.PROJECT_CD     , MAX(A.RANK_SORT) AS RANK_SORT     , MAX(A.SM_SI_CMPT) AS SM_SI_CMPT     , SUM(A.REQ_CNT) AS REQ_CNT     , SUM(A.CMPT_CNT) AS CMPT_CNT     , SUM(A.SCORE_SUM) AS SCORE_SUM     , MAX(A.SM_SI_PRAR) AS SM_SI_PRAR  FROM W_JOIN AGROUP BY A.USR_ID, A.PROJECT_CDORDER BY MAX(A.RANK_SORT), (SELECT LOC_NM FROM CRM_USR_MST U WHERE U.USR_ID = A.USR_ID), (CASE WHEN A.PROJECT_CD IS NULL THEN 'A' ELSE (CASE WHEN SM_SI_CMPT IS NULL THEN 'C'||SM_SI_CMPT ELSE 'B'||SM_SI_CMPT END) END)
#CrmAsWeekly@SearchDevDetail
--CrmAsWeekly@SearchDevDetailSELECT B.MNGT_NO     , B.PRIORITY      , B.REQ_YMD||' '||B.REQ_HM AS REQ_YMD     , B.REQ_HM      , B.CUST_CD      , (SELECT MAX(Z.CUST_LOC_NM) FROM CRM_CUST_MST Z WHERE Z.CUST_CD = B.CUST_CD) AS CUST_NM      , B.CONTENT     , B.REQ_USR     , B.TEL_NO      , NVL(A.PROC_TYPE,'1') AS PROC_TYPE     , (SELECT LOC_NM FROM CRM_USR_MST  X WHERE X.USR_ID =A.USR_ID) AS WORK_USR_NM      , A.PRAR_YMD     , A.CMPT_YMD     , (SELECT MAX(Z.LOC_NM) FROM CRM_USR_MST Z WHERE Z.USR_ID = A.USR_ID) AS INS_USR_NM     , (CASE WHEN (SELECT COUNT(X.MNGT_NO) FROM COM_DOC_MST X WHERE X.MNGT_NO = B.MNGT_NO) >= 1 THEN 'Y' ELSE 'N' END) AS FILE_YN     , B.RMK||CHR(13)||CHR(10)||A.DEV_CONTENT AS RMK     , B.PGM_MDF     , A.REQ_SVC     , A.REQ_SVC2     , A.REQ_SVC3     , UFN_FORMAT(B.INS_YMD,'DATE') AS INS_YMD     , B.DEV_ERR_YN     , B.SHARE_YN     , (CASE A.RANK WHEN 'A' THEN '상' WHEN 'B' THEN '중' WHEN 'C' THEN '하' ELSE '' END) AS RANK     , ( CASE WHEN A.RANK7  = 'Y' THEN '단순문의,' END        ||CASE WHEN A.RANK10 = 'Y' THEN '업무분석' END       ||CASE WHEN A.RANK11 = 'Y' THEN '설계' END       ||CASE WHEN A.RANK1  = 'Y' THEN '신규(개발),' END        ||CASE WHEN A.RANK2  = 'Y' THEN '화면변경,' END        ||CASE WHEN A.RANK3  = 'Y' THEN '로직수정,' END        ||CASE WHEN A.RANK4  = 'Y' THEN '쿼리수정,' END        ||CASE WHEN A.RANK5  = 'Y' THEN 'RPT추가,' END        ||CASE WHEN A.RANK6  = 'Y' THEN 'RPT변경,' END        ||CASE WHEN A.RANK8  = 'Y' THEN 'Data변경,' END        ||CASE WHEN A.RANK9  = 'Y' THEN 'EDI확인,'END        ||CASE WHEN A.RANK15 = 'Y' THEN '기타' END       ||CASE WHEN A.RANK12 = 'Y' THEN '화면디자인' END       ||CASE WHEN A.RANK13 = 'Y' THEN '설치' END       ||CASE WHEN A.RANK14 = 'Y' THEN '통합테스트' END       ||CASE WHEN A.RANK16 = 'Y' THEN 'Data이관' END       ||CASE WHEN A.RANK17 = 'Y' THEN '산출물작성' END)  AS DEV_ITEM     , NVL(UFN_AS_SCORE(A.MNGT_NO),0) AS SCORE     , A.DEV_SCORE     , A.DEV_SCORE_RMK     , B.DEV_ERR_NM     , A.SEQ     , A.USR_ID     , (CASE WHEN A.PRAR_YMD IS NULL THEN TO_DATE(B.REQ_YMD)+6 ELSE TO_DATE(A.PRAR_YMD) END) AS CHK_PRAR_YMD                  , TO_DATE(TO_CHAR(SYSDATE,'yyyyMMdd')) AS CHK_TODAY       , B.PROJECT_CD     , UFN_GET_COM_INFO('T16',B.PROJECT_CD) AS PROJECT_NM  FROM CRM_AS_MST_WORK A       INNER JOIN CRM_AS_MST B       ON A.MNGT_NO = B.MNGT_NO       INNER JOIN CRM_USR_MST C       ON A.USR_ID = C.USR_ID AND C.USE_YN = 'Y' WHERE A.SEQ <> 0 [CMPT_YMD]   AND A.CMPT_YMD >= '@FM_YMD' AND A.CMPT_YMD <= '@TO_YMD' [/CMPT_YMD] [PRAR_YMD]   AND A.CMPT_YMD IS NULL   AND A.PRAR_YMD >= '@FM_YMD_NEXT' AND A.PRAR_YMD <= '@TO_YMD_NEXT' [/PRAR_YMD]  [DEV_PIC_CD]   AND A.USR_ID IN ('@DEV_PIC_CD') [/DEV_PIC_CD] [DEPT_CD]   AND A.DEPT_CD IN ('@DEPT_CD') [/DEPT_CD] [PROJECT_CD]   AND B.PROJECT_CD = '@PROJECT_CD' [/PROJECT_CD]
