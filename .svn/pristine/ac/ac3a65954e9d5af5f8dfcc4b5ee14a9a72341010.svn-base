#CrmAsMgt_v2@Delete
--CrmAsMgt_v2@DeletDELETE CRM_AS_MST WHERE MNGT_NO ='@MNGT_NO'
#CrmAsMgt_v2@DeleteWorkDetail
--CrmAsMgt_v2@DeleteWorkDetail  Delete CRM_AS_MST_WORK   Where MNGT_NO = '@MNGT_NO'  	 And SEQ = @SEQ	
#CrmAsMgt_v2@GetReqSvc2List
--CrmAsMgt_v2@GetReqSvc2ListSELECT   COMN_CD AS CODE        ,  CD_NM AS NAME        , OPT_ITEM1 AS GRP_CD        , SORT  FROM MDM_COM_CODE WHERE GRP_CD = 'T10'
#CrmAsMgt_v2@Insert
-- CrmAsMgt_v2@InsertINSERT INTO CRM_AS_MST (	  MNGT_NO	, INS_USR	, INS_YMD	, INS_HM	[REQ_YMD], REQ_YMD[/REQ_YMD]	[REQ_HM], REQ_HM[/REQ_HM]	[REQ_SVC], REQ_SVC[/REQ_SVC]	[REQ_SVC2], REQ_SVC2 [/REQ_SVC2]	[CUST_CD], CUST_CD[/CUST_CD]	[CONTENT], CONTENT[/CONTENT]	[REQ_USR], REQ_USR[/REQ_USR]	[TEL_NO], TEL_NO[/TEL_NO]	[PROC_TYPE], PROC_TYPE[/PROC_TYPE]	[REQ_TYPE], REQ_TYPE[/REQ_TYPE]	[REQ_TYPE2], REQ_TYPE2[/REQ_TYPE2]	[PRIORITY], PRIORITY[/PRIORITY]	--[WORK_USR], WORK_USR[/WORK_USR]	[PRAR_YMD], PRAR_YMD[/PRAR_YMD]	[CMPT_YMD], CMPT_YMD[/CMPT_YMD]	[FREE_YN], FREE_YN[/FREE_YN]	[RMK], RMK[/RMK]	[CMPT_RMK], CMPT_RMK[/CMPT_RMK]	,DEPT_CD  ) VALUES (       '@MNGT_NO'	 , '@USR_ID'	 , TO_CHAR(SYSDATE,'yyyyMMdd')	 , TO_CHAR(SYSDATE,'HH24MISS')	 [REQ_YMD], '@REQ_YMD'[/REQ_YMD]	 [REQ_HM], '@REQ_HM'[/REQ_HM]	 [REQ_SVC], '@REQ_SVC'[/REQ_SVC]	 [REQ_SVC2], '@REQ_SVC2'[/REQ_SVC2]	 [CUST_CD], '@CUST_CD'[/CUST_CD]	 [CONTENT], '@CONTENT'[/CONTENT]	 [REQ_USR], '@REQ_USR'[/REQ_USR]	 [TEL_NO], '@TEL_NO'[/TEL_NO]	 [PROC_TYPE], '@PROC_TYPE'[/PROC_TYPE]	 [REQ_TYPE], '@REQ_TYPE'[/REQ_TYPE]	 [REQ_TYPE2], '@REQ_TYPE2'[/REQ_TYPE2]	 [PRIORITY], '@PRIORITY'[/PRIORITY]	-- [WORK_USR], '@WORK_USR'[/WORK_USR]	 [PRAR_YMD], '@PRAR_YMD'[/PRAR_YMD]	 [CMPT_YMD], '@CMPT_YMD'[/CMPT_YMD]	 [FREE_YN], '@FREE_YN'[/FREE_YN]	 [RMK], '@RMK'[/RMK]	 [CMPT_RMK], '@CMPT_RMK'[/CMPT_RMK]	 , '@DEPT_CD')
#CrmAsMgt_v2@InsertPicInfo
--CrmAsMgt_v2@InsertPicInfo  MERGE INTO  CRM_CUST_PIC C        USING ( SELECT '@CUST_CD' AS CUST_CD                      ,'@PIC_NM' AS PIC_NM                  FROM DUAL )  A     ON (     C.CUST_CD = A.CUST_CD         AND C.PIC_NM  = A.PIC_NM )WHEN MATCHED THEN     UPDATE SET C.TEL_NO = '@TEL_NO'WHEN NOT MATCHED THEN     INSERT (C.CUST_CD , C.SEQ, C.PIC_NM, C.TEL_NO)     VALUES('@CUST_CD', (SELECT NVL(MAX(SEQ),0)+1 FROM CRM_CUST_PIC WHERE CUST_CD = '@CUST_CD'),'@PIC_NM','@TEL_NO')               
#CrmAsMgt_v2@InsertPicInfo1
--CrmAsMgt_v2@UpdateMergeWorkUsr  MERGE INTO  CRM_AS_MST_WORK W        USING ( SELECT '@MNGT_NO' AS MNGT_NO                      ,'@USR_ID' AS USR_ID                       ,'@WORK_TYPE' AS WORK_TYPE                      ,'@WORK_VALUE' AS WORK_VALUE                      , ( SELECT DEPT_CD                            FROM CRM_USR_MST                           WHERE USR_ID = '@USR_ID') AS DEPT_CD                 FROM DUAL )  A     ON (     W.MNGT_NO = A.MNGT_NO         AND W.USR_ID  = A.USR_ID         AND W.WORK_TYPE = A.WORK_TYPE )WHEN MATCHED THEN     UPDATE SET W.DEPT_CD = A.DEPT_CD     , W.WORK_VALUE = A.WORK_VALUEWHEN NOT MATCHED THEN     INSERT (W.MNGT_NO , W.USR_ID, W.WORK_TYPE ,W.WORK_VALUE  , W.DEPT_CD)     VALUES ( A.MNGT_NO , A.USR_ID, A.WORK_TYPE ,A.WORK_VALUE , A.DEPT_CD )
#CrmAsMgt_v2@InsertShareData
--CrmAsMgt_v2@InsertShareData   MERGE INTO  CRM_AS_MST_SHARE C      USING ( SELECT '@MNGT_NO' AS MNGT_NO                    ,'@DEPT_CD' AS DEPT_CD                  FROM DUAL )  A     ON (     C.MNGT_NO = A.MNGT_NO         AND C.DEPT_CD  = A.DEPT_CD ) WHEN MATCHED THEN     UPDATE SET C.EXCEPT_YN   ='N'WHEN NOT MATCHED THEN     INSERT (C.MNGT_NO , C.DEPT_CD)     VALUES('@MNGT_NO', '@DEPT_CD' )      
#CrmAsMgt_v2@InsertWorkDetail
--CrmAsMgt_v2@InsertWorkDetailInsert Into CRM_AS_MST_WORK(	 MNGT_NO 	,SEQ 	,USR_ID 	,DEPT_CD  	,TEST_RESULT 	,CONTENT 	,DEV_CONTENT	,PROC_TYPE	,REQ_SVC	,REQ_SVC3	)Values (	'@MNGT_NO' 	,NVL((SELECT NVL(MAX(SEQ),0)	   FROM CRM_AS_MST_WORK	  WHERE MNGT_NO = '@MNGT_NO'	    AND USR_ID = '@USR_ID'	    AND SEQ <> 0 ) ,0)+1	,'@USR_ID' 	,(SELECT DEPT_CD FROM CRM_USR_MST WHERE USR_ID = '@USR_ID') 	,'@TEST_RESULT'  	,'@CONTENT' 	,'@DEV_CONTENT'	,NVL('@PROC_TYPE','1')	,(SELECT NVL(OPT_ITEM2,COMN_CD) FROM MDM_COM_CODE WHERE GRP_CD = 'T02' AND COMN_CD = '@REQ_SVC') 	,(SELECT NVL(OPT_ITEM2,COMN_CD) FROM MDM_COM_CODE WHERE GRP_CD = 'T05' AND COMN_CD = '@REQ_TYPE')  ) 
#CrmAsMgt_v2@Search
--CrmAsMgt_v2@SearchWITH W_CRM_AS_MSTAS (	SELECT * 	  FROM (		SELECT A.MNGT_NO		     , UFN_FORMAT(A.REQ_YMD,'DATE') AS REQ_YMD		     , UFN_FORMAT(A.REQ_HM,'TIME') AS REQ_HM		     , A.REQ_SVC		     , A.REQ_SVC2		     , A.CUST_CD		     , B.CUST_LOC_NM AS CUST_NM		     , A.CONTENT		     , A.REQ_USR 		     , A.TEL_NO		     , A.PROC_TYPE 
		     , A.REQ_TYPE		     , A.REQ_TYPE2		     , A.PRIORITY		     , ( SELECT REPLACE( WM_CONCAT( DISTINCT (SELECT LOC_NM FROM CRM_USR_MST U WHERE U.USR_ID = X.USR_ID )) ,',',', ')	                   FROM CRM_AS_MST_WORK X	                  WHERE X.MNGT_NO = A.MNGT_NO	                    AND X.DEPT_CD = A.DEPT_CD	                    AND X.SEQ = 0	                    ) AS WORK_USR		     , UFN_FORMAT(A.PRAR_YMD,'DATE') AS PRAR_YMD		     , UFN_FORMAT(A.CMPT_YMD,'DATE') AS CMPT_YMD		     , A.RMK		     , A.RMK AS RMK2		     , A.CMPT_RMK		     , CASE WHEN A.MNGT_NO = '@S_MNGT_NO'		            THEN 'A'		            ELSE 'B'		       END SORT_NO		     , (SELECT Z.LOC_NM FROM CRM_USR_MST Z WHERE  Z.USR_ID = A.INS_USR) AS INS_USR		     , B.USE_YN		     , B.MATN_YN		     , A.FREE_YN		     , CASE WHEN (SELECT COUNT(X.MNGT_NO)	                        FROM COM_DOC_MST X	                       WHERE X.MNGT_NO = A.MNGT_NO) >= 1	                THEN 'Y'	                ELSE 'N'	           END AS FILE_YN	         , A.SYS_ID 			 , NVL( NVL( ( SELECT REPLACE( WM_CONCAT( REPLACE( X.DEPT_CD,A.DEPT_CD,'') ) ,',','; ')	                         FROM CRM_AS_MST_SHARE X	                      WHERE X.MNGT_NO = A.MNGT_NO) ,'') , '@DEPT_CD') AS DEPT_AUTH_LIST	         , ( SELECT REPLACE( WM_CONCAT( DISTINCT USR_ID) ,',','; ')	                   FROM CRM_AS_MST_WORK X	                  WHERE X.MNGT_NO = A.MNGT_NO	                    AND X.DEPT_CD = '@DEPT_CD'	                    ) AS WORK_USR_LIST	        , CASE WHEN A.SYS_ID = 'ELVIS'	               THEN '고객'	               ELSE 'CRM'	               END AS SYS_NM	        ,UFN_FORMAT(A.DEV_CMPT_YMD,'DATE') AS DEV_CMPT_YMD	        , CASE WHEN DEV_CMPT_YMD IS NULL	               THEN 'No'	               WHEN PROC_TYPE NOT IN ('1','8') AND DEV_CMPT_YMD IS NOT NULL 	               THEN 'Yes'	               ELSE 'No'	               END DEV_CMPT_YN	           , NVL((SELECT MAX(CASE WHEN RETURN_YN = 'Y' AND X.DEPT_CD <> '@DEPT_CD' AND A.DEPT_CD = '@DEPT_CD'	        			   THEN '반려'	        			   WHEN X.DEPT_CD = '@DEPT_CD' AND X.RETURN_YN = 'A'	        			   THEN '재확인'	                       ELSE ''	                       END )	              FROM CRM_AS_MST_SHARE X	             WHERE X.MNGT_NO = A.MNGT_NO),'') AS RETURN_YN	           ,CASE  WHEN NVL(( SELECT MAX(USR_ID)	                         FROM CRM_AS_MST_WORK X			                WHERE SEQ <> 0 			                  AND X.MNGT_NO = A.MNGT_NO			                  AND X.DEPT_CD <> A.DEPT_CD),'')			               = ''			          THEN ''			          ELSE ( SELECT CASE WHEN COUNT(SEQ)  = 0			                           THEN '미분배'			                           ELSE '분배'			                           END 			                 FROM CRM_AS_MST_WORK X			                WHERE SEQ <> 0 			                  AND X.MNGT_NO = A.MNGT_NO			                )			          END  AS DIV_JOB	           ,( SELECT REPLACE( WM_CONCAT( REPLACE (  UFN_GET_COM_INFO('T07',NVL(X.PROC_TYPE,'01'),'OPT_ITEM1') || ':'	                                || '  '   ||    ( SELECT LOC_NM				                                    	FROM CRM_USR_MST A	                                                   WHERE A.USR_ID  = X.USR_ID ) 	                                ||  CHR(13) || CHR(10) 	                                ||   X.DEV_CONTENT, ',' ,'^!' ) ) ,',' , CHR(13) || CHR(10) ||  CHR(13) || CHR(10)  ) AS DEV_CONTENT					FROM CRM_AS_MST_WORK X					WHERE X.MNGT_NO = A.MNGT_NO					  AND X.SEQ <> 0					  AND X.DEPT_CD <> A.DEPT_CD ) AS WORK_CONTENT 	           ,(  SELECT  WM_CONCAT( CD_NM ) 			         FROM CRM_AS_MST_SHARE X , MDM_COM_CODE X1			        WHERE EXCEPT_YN = 'N'			          AND X1.GRP_CD= 'C03'  			          AND X1.COMN_CD = X.DEPT_CD			          AND X.MNGT_NO = A.MNGT_NO) AS SHARE_DEPT		  FROM CRM_AS_MST A  		       INNER JOIN CRM_CUST_MST B	                   ON A.CUST_CD = B.CUST_CD		 WHERE 1 = 1		    [CUST_CD]		       AND A.CUST_CD = '@CUST_CD'		    [/CUST_CD]	[S_REQ_YMD]		    [FM_YMD]		       AND A.REQ_YMD >= '@FM_YMD'		    [/FM_YMD]		    [TO_YMD]		       AND A.REQ_YMD <= '@TO_YMD'		    [/TO_YMD]	[/S_REQ_YMD]	 	[S_CMPT_YMD] 		    [FM_YMD]		       AND A.CMPT_YMD >= '@FM_YMD'		    [/FM_YMD]		    [TO_YMD]		       AND A.CMPT_YMD <= '@TO_YMD'		    [/TO_YMD]	[/S_CMPT_YMD]    		    [S_PROC_TYPE]		       AND A.PROC_TYPE IN ('@S_PROC_TYPE')		    [/S_PROC_TYPE]		    [S_SVC_CD]		       --AND B.SVC_CD IN ('@S_SVC_CD')		       AND B.CUST_CD IN (SELECT CUST_CD FROM CRM_CUST_SVC WHERE SVC_CD IN ('@S_SVC_CD'))		    [/S_SVC_CD]		    [SEARCH_KEY]			   AND ( 1 != 1			   OR A.CUST_CD LIKE '%@SEARCH_KEY%'			   OR B.CUST_NM LIKE '%@SEARCH_KEY%'			   OR B.CUST_LOC_NM LIKE '%@SEARCH_KEY%'			   OR B.DOMAIN LIKE '%@SEARCH_KEY%' 				   OR A.TEL_NO LIKE '%@SEARCH_KEY%'			   OR B.CUSTOMS_CD LIKE '%@SEARCH_KEY%'			   OR A.REQ_USR LIKE '%@SEARCH_KEY%'			   OR A.WORK_USR LIKE '%@SEARCH_KEY%'			   OR A.MNGT_NO LIKE '%@SEARCH_KEY%'			   OR A.CONTENT LIKE '%@SEARCH_KEY%'			   OR A.MNGT_NO IN (SELECT MNGT_NO								  FROM CRM_AS_MST_WORK								 WHERE USR_ID IN (SELECT VALUE1								  FROM TABLE(  UFN_GET_INFO('USER_LIST','%@SEARCH_KEY%')))  )			  )			[/SEARCH_KEY]			[S_DEPT_CD]			  AND ( A.DEPT_CD IN ('@S_DEPT_CD') OR A.DEPT_CD IS NULL  )			[/S_DEPT_CD]			[S_DEPT_AUTH_LIST]			  AND ( A.MNGT_NO IN ( 			                      SELECT MNGT_NO 			                       FROM CRM_AS_MST_SHARE			                      WHERE DEPT_CD IN ('@S_DEPT_AUTH_LIST') 			                        AND EXCEPT_YN = 'N'			                      UNION ALL 					            SELECT MNGT_NO					              FROM CRM_AS_MST_WORK X					            WHERE SEQ <> 0   					                AND X.DEPT_CD = A.DEPT_CD  			                      )  			       OR  A.DEPT_CD IN ('@DEPT_CD')			                      )			[/S_DEPT_AUTH_LIST]	  ) ORDER BY SORT_NO	  [WORK_USR]	           , CASE WHEN WORK_USR LIKE '%@WORK_USR%' OR MNGT_NO IN (SELECT MNGT_NO																	    FROM CRM_AS_MST_WORK																	   WHERE USR_ID IN (SELECT VALUE1																                          FROM TABLE(  UFN_GET_INFO('USER_LIST','%@WORK_USR%')))  )	                  THEN 1	                  ELSE 2 	                  END	  [/WORK_USR]	  [PRIORITY]	           , PRIORITY	  [/PRIORITY]	  ,REQ_YMD||REQ_HM DESC)SELECT NVL((SELECT (CASE WHEN E.SUBJECT IS NULL THEN NULL ELSE '제목:'||TRIM(E.SUBJECT)||CHR(13)||CHR(10)||'내용:'||A.CONTENT END) FROM CRM_AS_CUST E WHERE A.MNGT_NO = E.MNGT_NO),A.CONTENT) AS CONTENT
     , A.*  FROM W_CRM_AS_MST A WHERE 1 = 1 [ROWNUM]   AND ROWNUM <= @ROWNUM [/ROWNUM]
#CrmAsMgt_v2@Search_20210909
--CrmAsMgt_v2@SearchWITH W_CRM_CUST_SVCAS(    SELECT A.CUST_CD         , SUBSTR(            XMLAGG(                XMLELEMENT(COL ,',', B.CD_NM) ORDER BY B.CD_NM).EXTRACT('//text()'            ).GETSTRINGVAL()           , 2) AS SVC_CD         , SUBSTR(            XMLAGG(                XMLELEMENT(COL ,',', C.CD_NM) ORDER BY B.CD_NM).EXTRACT('//text()'            ).GETSTRINGVAL()           , 2) AS DEPT_CD         , SUBSTR(            XMLAGG(                XMLELEMENT(COL ,',', A.SALES_NM) ORDER BY B.CD_NM).EXTRACT('//text()'            ).GETSTRINGVAL()           , 2) AS SALES_NM      FROM CRM_CUST_SVC A           INNER JOIN MDM_COM_CODE B                   ON A.SVC_CD = B.COMN_CD                  AND B.GRP_CD = 'C01'           INNER JOIN MDM_COM_CODE C                   ON A.DEPT_CD = C.COMN_CD                  AND C.GRP_CD = 'C03'     WHERE A.SVC_CD IS NOT NULL     GROUP BY A.CUST_CD ), W_CRM_AS_MSTAS (	SELECT * 	  FROM (		SELECT A.MNGT_NO		     , UFN_FORMAT(A.REQ_YMD,'DATE') AS REQ_YMD		     , UFN_FORMAT(A.REQ_HM,'TIME') AS REQ_HM		     , A.REQ_SVC		     , A.REQ_SVC2		     , A.CUST_CD		     , B.CUST_LOC_NM AS CUST_NM		     --, A.CONTENT		     , (CASE WHEN E.SUBJECT IS NULL THEN A.CONTENT	                 ELSE '제목:'||TRIM(E.SUBJECT)||CHR(13)||CHR(10)||'내용:'||A.CONTENT	            END) AS CONTENT		     , A.REQ_USR 		     , A.TEL_NO		     , A.PROC_TYPE 		  /*   , CASE WHEN A.PROC_TYPE IN ('1','2') 		            THEN '완료'		            WHEN A.PROC_TYPE = '8'		            THEN '보류'		            ELSE '미완료'	 	            END  AS PROC_TYPE_YN*/		     , A.REQ_TYPE		     , A.REQ_TYPE2		     , A.PRIORITY		     --, A.WORK_USR		     , ( SELECT REPLACE( WM_CONCAT( DISTINCT (SELECT LOC_NM FROM CRM_USR_MST U WHERE U.USR_ID = X.USR_ID )) ,',',', ')	                   FROM CRM_AS_MST_WORK X	                  WHERE X.MNGT_NO = A.MNGT_NO	                    AND X.DEPT_CD = A.DEPT_CD	                    AND X.SEQ = 0	                    ) AS WORK_USR		     , UFN_FORMAT(A.PRAR_YMD,'DATE') AS PRAR_YMD		     , UFN_FORMAT(A.CMPT_YMD,'DATE') AS CMPT_YMD		     , A.RMK		     , A.RMK AS RMK2		     , A.CMPT_RMK		     , CASE WHEN A.MNGT_NO = '@S_MNGT_NO'		            THEN 'A'		            ELSE 'B'		       END SORT_NO		     , (SELECT Z.LOC_NM FROM CRM_USR_MST Z WHERE  Z.USR_ID = A.INS_USR) AS INS_USR		     , B.USE_YN		     , D.SVC_CD		     , B.MATN_YN		     , D.SALES_NM		     , A.FREE_YN		     , CASE WHEN (SELECT COUNT(X.MNGT_NO)	                        FROM COM_DOC_MST X	                       WHERE X.MNGT_NO = A.MNGT_NO) >= 1	                THEN 'Y'	                ELSE 'N'	           END AS FILE_YN	         , A.SYS_ID 			 , NVL( NVL( ( SELECT REPLACE( WM_CONCAT( REPLACE( X.DEPT_CD,A.DEPT_CD,'') ) ,',','; ')	                         FROM CRM_AS_MST_SHARE X	                      WHERE X.MNGT_NO = A.MNGT_NO) ,'') , '@DEPT_CD') AS DEPT_AUTH_LIST	         , ( SELECT REPLACE( WM_CONCAT( DISTINCT USR_ID) ,',','; ')	                   FROM CRM_AS_MST_WORK X	                  WHERE X.MNGT_NO = A.MNGT_NO	                    AND X.DEPT_CD = '@DEPT_CD'	                   -- AND X.WORK_TYPE ='WORK'	                    ) AS WORK_USR_LIST	        , CASE WHEN A.SYS_ID = 'ELVIS'	               THEN '고객'	               ELSE 'CRM'	               END AS SYS_NM	        ,UFN_FORMAT(A.DEV_CMPT_YMD,'DATE') AS DEV_CMPT_YMD	        , CASE WHEN DEV_CMPT_YMD IS NULL	               THEN 'No'	               WHEN PROC_TYPE NOT IN ('1','8') AND DEV_CMPT_YMD IS NOT NULL 	               THEN 'Yes'	               ELSE 'No'	               END DEV_CMPT_YN	           , NVL((SELECT MAX(CASE WHEN RETURN_YN = 'Y' AND X.DEPT_CD <> '@DEPT_CD' AND A.DEPT_CD = '@DEPT_CD'	        			   THEN '반려'	        			   WHEN X.DEPT_CD = '@DEPT_CD' AND X.RETURN_YN = 'A'	        			   THEN '재확인'	                       ELSE ''	                       END )	              FROM CRM_AS_MST_SHARE X	             WHERE X.MNGT_NO = A.MNGT_NO),'') AS RETURN_YN	           ,CASE  WHEN NVL(( SELECT MAX(USR_ID)	                         FROM CRM_AS_MST_WORK X			                WHERE SEQ <> 0 			                  AND X.MNGT_NO = A.MNGT_NO			                  AND X.DEPT_CD <> A.DEPT_CD),'')			               = ''			          THEN ''			          ELSE ( SELECT CASE WHEN COUNT(SEQ)  = 0			                           THEN '미분배'			                           ELSE '분배'			                           END 			                 FROM CRM_AS_MST_WORK X			                WHERE SEQ <> 0 			                  AND X.MNGT_NO = A.MNGT_NO			                 -- AND X.DEPT_CD <> A.DEPT_CD 			                )			          END  AS DIV_JOB	           ,( SELECT REPLACE( WM_CONCAT( REPLACE (  UFN_GET_COM_INFO('T07',NVL(X.PROC_TYPE,'01'),'OPT_ITEM1') || ':'	                                || '  '   ||    ( SELECT LOC_NM				                                    	FROM CRM_USR_MST A	                                                   WHERE A.USR_ID  = X.USR_ID ) 	                                ||  CHR(13) || CHR(10) 	                                ||   X.DEV_CONTENT, ',' ,'^!' ) ) ,',' , CHR(13) || CHR(10) ||  CHR(13) || CHR(10)  ) AS DEV_CONTENT					FROM CRM_AS_MST_WORK X					WHERE X.MNGT_NO = A.MNGT_NO					  AND X.SEQ <> 0					  AND X.DEPT_CD <> A.DEPT_CD ) AS WORK_CONTENT 	           ,(  SELECT  WM_CONCAT( CD_NM ) 			         FROM CRM_AS_MST_SHARE X , MDM_COM_CODE X1			        WHERE EXCEPT_YN = 'N'			          AND X1.GRP_CD= 'C03'  			          AND X1.COMN_CD = X.DEPT_CD			          AND X.MNGT_NO = A.MNGT_NO) AS SHARE_DEPT		  FROM CRM_AS_MST A  		       INNER JOIN CRM_CUST_MST B	                   ON A.CUST_CD = B.CUST_CD	           LEFT OUTER JOIN W_CRM_CUST_SVC D	                   ON A.CUST_CD = D.CUST_CD	           LEFT OUTER JOIN CRM_AS_CUST E	                   ON A.MNGT_NO = E.MNGT_NO		 WHERE 1 = 1		    [CUST_CD]		       AND A.CUST_CD = '@CUST_CD'		    [/CUST_CD]	[S_REQ_YMD]		    [FM_YMD]		       AND A.REQ_YMD >= '@FM_YMD'		    [/FM_YMD]		    [TO_YMD]		       AND A.REQ_YMD <= '@TO_YMD'		    [/TO_YMD]	[/S_REQ_YMD]	 	[S_CMPT_YMD] 		    [FM_YMD]		       AND A.CMPT_YMD >= '@FM_YMD'		    [/FM_YMD]		    [TO_YMD]		       AND A.CMPT_YMD <= '@TO_YMD'		    [/TO_YMD]	[/S_CMPT_YMD]    		    [S_PROC_TYPE]		       AND A.PROC_TYPE IN ('@S_PROC_TYPE')		    [/S_PROC_TYPE]		    [S_SVC_CD]		       --AND B.SVC_CD IN ('@S_SVC_CD')		       AND B.CUST_CD IN (SELECT CUST_CD FROM CRM_CUST_SVC WHERE SVC_CD IN ('@S_SVC_CD'))		    [/S_SVC_CD]		    [SEARCH_KEY]			   AND ( 1 != 1			   OR A.CUST_CD LIKE '%@SEARCH_KEY%'			   OR B.CUST_NM LIKE '%@SEARCH_KEY%'			   OR B.CUST_LOC_NM LIKE '%@SEARCH_KEY%'			   OR B.DOMAIN LIKE '%@SEARCH_KEY%' 				   OR A.TEL_NO LIKE '%@SEARCH_KEY%'			   OR B.CUSTOMS_CD LIKE '%@SEARCH_KEY%'			   OR A.REQ_USR LIKE '%@SEARCH_KEY%'			   OR A.WORK_USR LIKE '%@SEARCH_KEY%'			   OR A.MNGT_NO LIKE '%@SEARCH_KEY%'			   OR A.CONTENT LIKE '%@SEARCH_KEY%'			   OR A.MNGT_NO IN (SELECT MNGT_NO								  FROM CRM_AS_MST_WORK								 WHERE USR_ID IN (SELECT VALUE1								  FROM TABLE(  UFN_GET_INFO('USER_LIST','%@SEARCH_KEY%')))  )			  )			[/SEARCH_KEY]			[S_DEPT_CD]			  AND ( A.DEPT_CD IN ('@S_DEPT_CD') OR A.DEPT_CD IS NULL  )			[/S_DEPT_CD]			[S_DEPT_AUTH_LIST]			  AND ( A.MNGT_NO IN ( 			                      SELECT MNGT_NO 			                       FROM CRM_AS_MST_SHARE			                      WHERE DEPT_CD IN ('@S_DEPT_AUTH_LIST') 			                        AND EXCEPT_YN = 'N'			                      UNION ALL 					            SELECT MNGT_NO					              FROM CRM_AS_MST_WORK X					            WHERE SEQ <> 0   					                AND X.DEPT_CD = A.DEPT_CD  			                      )  			       OR  A.DEPT_CD IN ('@DEPT_CD')			                      )			[/S_DEPT_AUTH_LIST]	  ) ORDER BY SORT_NO	  [WORK_USR]	           , CASE WHEN WORK_USR LIKE '%@WORK_USR%' OR MNGT_NO IN (SELECT MNGT_NO																	    FROM CRM_AS_MST_WORK																	   WHERE USR_ID IN (SELECT VALUE1																                          FROM TABLE(  UFN_GET_INFO('USER_LIST','%@WORK_USR%')))  )	                  THEN 1	                  ELSE 2 	                  END	  [/WORK_USR]	  [PRIORITY]	           , PRIORITY	  [/PRIORITY]	  ,REQ_YMD||REQ_HM DESC)SELECT *  FROM W_CRM_AS_MST WHERE 1 = 1 [ROWNUM]   AND ROWNUM <= @ROWNUM [/ROWNUM]
#CrmAsMgt_v2@SearchCustomer
-- CrmAsMgt_v2@SearchCustomerSELECT CUST_CD     , CUST_LOC_NM      , TEL_NO  FROM CRM_CUST_MST WHERE (1=2        OR CUST_CD LIKE '%@SEARCH_KEY%'        OR CUST_NM LIKE '%@SEARCH_KEY%'        OR CUST_LOC_NM LIKE '%@SEARCH_KEY%'        OR TEL_NO LIKE '%@SEARCH_KEY%'       )   AND USE_YN = 'Y'
#CrmAsMgt_v2@SearchCustomerPic
--CrmAsMgt_v2@SearchCustomerPicSELECT B.PIC_NM     , B.TEL_NO     , (CASE B.RANK              WHEN 'A' THEN '사장'             WHEN 'B' THEN '전무'             WHEN 'C' THEN '상무'             WHEN 'D' THEN '이사'             WHEN 'E' THEN '부장'             WHEN 'F' THEN '차장'             WHEN 'G' THEN '과장'             WHEN 'H' THEN '대리'             WHEN 'I' THEN '계장'             WHEN 'J' THEN '주임'             WHEN 'K' THEN '사원'             WHEN 'L' THEN '책임'             WHEN 'M' THEN '선임'             ELSE B.RANK        END) AS RANK_NM  FROM CRM_CUST_MST A     , CRM_CUST_PIC B WHERE A.CUST_CD = '@CUST_CD'   AND A.CUST_CD = B.CUST_CD   AND (1=2        OR B.PIC_NM LIKE '%@SEARCH_KEY%'        OR B.TEL_NO LIKE '%@SEARCH_KEY%'        OR B.EMAIL LIKE '%@SEARCH_KEY%'        OR B.RMK LIKE '%@SEARCH_KEY%'       )
#CrmAsMgt_v2@SearchInput
--CrmAsMgt_v2@SearchInputSELECT A.MNGT_NO     , A.REQ_YMD     , A.REQ_HM     , A.REQ_SVC      , A.REQ_SVC2     , A.CUST_CD     , A.CUST_CD AS OLD_CUST_CD     , B.CUST_LOC_NM AS CUST_NM     , A.CONTENT     , A.DEV_CONTENT     , A.REQ_USR     , A.REQ_USR AS OLD_REQ_USR     , A.TEL_NO     , A.PROC_TYPE     , A.REQ_TYPE     , A.PRIORITY     , CASE WHEN A.WORK_USR IS NULL             THEN                 ( SELECT REPLACE( WM_CONCAT( ( SELECT LOC_NM FROM CRM_USR_MST X1 WHERE X1.USR_ID = X.USR_ID)) ,',',', ')	                 FROM CRM_AS_MST_WORK X			        WHERE X.MNGT_NO = A.MNGT_NO			          AND X.DEPT_CD = NVL(A.DEPT_CD,'@DEPT_CD')			          AND X.SEQ = 0			          --AND X.WORK_TYPE ='WORK'			          )			 END AS WORK_USR     , A.PRAR_YMD     , A.CMPT_YMD     , A.RMK     , A.CMPT_RMK     , A.FREE_YN     , A.SYS_ID     , A.FORM_ID     , A.CLOSE_YN     , NVL( NVL( ( SELECT REPLACE( WM_CONCAT(REPLACE( X.DEPT_CD,A.DEPT_CD ,'')) ,',','; ')                     FROM CRM_AS_MST_SHARE X                    WHERE X.MNGT_NO = A.MNGT_NO                      AND EXCEPT_YN   ='N' ) ,'' ) , '') AS DEPT_AUTH_LIST     , ( SELECT REPLACE( WM_CONCAT( USR_ID) ,',','; ')           FROM CRM_AS_MST_WORK X          WHERE X.MNGT_NO = A.MNGT_NO           AND X.DEPT_CD = A.DEPT_CD           AND X.SEQ = 0            ) AS WORK_USR_LIST     , CASE WHEN A.DEPT_CD IS NULL            THEN NVL((				   	SELECT DEPT_CD					FROM CRM_USR_MST X					WHERE X.USR_ID =A.INS_USR) ,'@DEPT_CD')            ELSE                 A.DEPT_CD            END AS DEPT_CD      ,REQ_TYPE2      ,REQ_TYPE       , CASE WHEN '@DEPT_CD' = A.DEPT_CD             THEN (SELECT MAX(CASE WHEN RETURN_YN  = 'Y'                                  THEN 'Y'                                  ELSE 'N'                                  END) AS RETURN_YN	                     FROM CRM_AS_MST_SHARE X	                    WHERE X.MNGT_NO = A.MNGT_NO )             ELSE                  NVL((SELECT MAX(CASE WHEN RETURN_YN  = 'Y'                                  THEN 'Y'                                  ELSE 'N'                                  END) AS RETURN_YN	                     FROM CRM_AS_MST_SHARE X	                    WHERE X.MNGT_NO = A.MNGT_NO 	                      AND X.DEPT_CD = '@DEPT_CD'),'N')	                      END AS RETURN_YN	 , (SELECT MAX(CASE RANK		             WHEN 'A' THEN '사장'		             WHEN 'B' THEN '전무'		             WHEN 'C' THEN '상무'		             WHEN 'D' THEN '이사'		             WHEN 'E' THEN '부장'		             WHEN 'F' THEN '차장'		             WHEN 'G' THEN '과장'		             WHEN 'H' THEN '대리'		             WHEN 'I' THEN '계장'		             WHEN 'J' THEN '주임'		             WHEN 'K' THEN '사원'		             WHEN 'L' THEN '책임'		             WHEN 'M' THEN '선임'		             ELSE RANK		        END)	      FROM CRM_CUST_PIC 	     WHERE CUST_CD = A.CUST_CD AND PIC_NM = A.REQ_USR) AS RANK_NM  FROM CRM_AS_MST A     , CRM_CUST_MST B WHERE A.MNGT_NO = '@MNGT_NO'   AND A.CUST_CD = B.CUST_CD
#CrmAsMgt_v2@SearchInsertUser
--CrmAsMgt_v2@SearchInsertUserSELECT INS_USR AS USR_ID        ,  ( SELECT MAX(LOC_NM)               FROM CRM_USR_MST              WHERE LOC_NM =  A.INS_USR ) AS LOC_NM                ,'@FLAG' AS FLAGFROM CRM_AS_MST AWHERE MNGT_NO = '@MNGT_NO'
#CrmAsMgt_v2@SearchToUserID
--CrmAsMgt_v2@SearchToUserIDSELECT USR_ID,LOC_NM, '@FLAG' AS FLAG  FROM CRM_USR_MST WHERE LOC_NM ='@LOC_NM'
#CrmAsMgt_v2@SearchWorkDetail
--CrmAsMgt_v2@SearchWorkDetailSELECT MNGT_NO      ,SEQ       ,USR_ID            ,DEPT_CD           ,TEST_REQ_YMD        ,TEST_USR_ID        ,CASE WHEN TEST_RESULT IS NULL            THEN '1'            ELSE TEST_RESULT            END AS  TEST_RESULT       ,CMPT_YMD        ,CONTENT           ,CASE WHEN PROC_TYPE IS NULL            THEN '1'            ELSE PROC_TYPE            END AS  PROC_TYPE       ,DEV_CONTENT       ,USR_ID AS ORG_USR_ID  FROM CRM_AS_MST_WORK WHERE MNGT_NO = '@MNGT_NO'   AND SEQ <> 0
#CrmAsMgt_v2@Update
--CrmAsMgt_v2@UpdateBEGIN UPDATE CRM_AS_MST   SET UPD_USR   = '@USR_ID'	 , UPD_YMD   = TO_CHAR(SYSDATE,'yyyyMMdd')	 , UPD_HM    = TO_CHAR(SYSDATE,'HH24MISS')	 [REQ_YMD], REQ_YMD   = '@REQ_YMD'[/REQ_YMD]	 [REQ_HM], REQ_HM    = '@REQ_HM'[/REQ_HM]	 [REQ_SVC], REQ_SVC   = '@REQ_SVC'[/REQ_SVC]	 [REQ_SVC2], REQ_SVC2   = '@REQ_SVC2'[/REQ_SVC2]	 [CUST_CD], CUST_CD   = '@CUST_CD'[/CUST_CD]	 [CONTENT], CONTENT   = '@CONTENT'[/CONTENT]	 [REQ_USR], REQ_USR   = '@REQ_USR'[/REQ_USR]	 [TEL_NO], TEL_NO    = '@TEL_NO'[/TEL_NO]	 [PROC_TYPE], PROC_TYPE = '@PROC_TYPE'[/PROC_TYPE]	 [REQ_TYPE], REQ_TYPE  = '@REQ_TYPE'[/REQ_TYPE]	 [REQ_TYPE2], REQ_TYPE2  = '@REQ_TYPE2'[/REQ_TYPE2]	 [PRIORITY], PRIORITY  = '@PRIORITY'[/PRIORITY]	-- [WORK_USR], WORK_USR  = '@WORK_USR'[/WORK_USR]	 [PRAR_YMD], PRAR_YMD  = '@PRAR_YMD'[/PRAR_YMD]	 [CMPT_YMD], CMPT_YMD  = '@CMPT_YMD'[/CMPT_YMD]	 [RMK], RMK       = '@RMK'[/RMK]	 [CMPT_RMK], CMPT_RMK  = '@CMPT_RMK'[/CMPT_RMK]	 [FREE_YN], FREE_YN   = '@FREE_YN'[/FREE_YN] WHERE MNGT_NO   = '@MNGT_NO';  UPDATE CRM_AS_MST_SHARE    SET RETURN_YN = '@RETURN_YN'  WHERE MNGT_NO = '@MNGT_NO'     AND DEPT_CD = '@USR_DEPT_CD';     UPDATE CRM_AS_MST_SHARE    SET RETURN_YN = 'A'    WHERE MNGT_NO = ( SELECT MNGT_NO                      FROM CRM_AS_MST                     WHERE DEPT_CD = '@USR_DEPT_CD'                       AND MNGT_NO = '@MNGT_NO')    AND '@RETURN_YN' = 'N'     AND RETURN_YN = 'Y' ;      UPDATE CRM_AS_MST     SET DEPT_CD = '@DEPT_CD'   WHERE DEPT_CD IS NULL     AND MNGT_NO = '@MNGT_NO'; /*   UPDATE CRM_AS_MST A    SET WORK_USR = ( SELECT REPLACE( WM_CONCAT( DISTINCT (SELECT LOC_NM FROM CRM_USR_MST U WHERE U.USR_ID = X.USR_ID )) ,',',', ')                   FROM CRM_AS_MST_WORK X                  WHERE X.MNGT_NO = A.MNGT_NO                    AND X.DEPT_CD = A.DEPT_CD                    AND X.SEQ = 0)WHERE MNGT_NO ='@MNGT_NO';*/ END ;
#CrmAsMgt_v2@Update2
-- CrmAsMgt_v2@Update2 UPDATE CRM_AS_MST A    SET WORK_USR = ( SELECT REPLACE( WM_CONCAT( DISTINCT (SELECT LOC_NM FROM CRM_USR_MST U WHERE U.USR_ID = X.USR_ID )) ,',',', ')                   FROM CRM_AS_MST_WORK X                  WHERE X.MNGT_NO = A.MNGT_NO                    AND X.DEPT_CD = A.DEPT_CD                    AND X.SEQ = 0)  WHERE MNGT_NO ='@MNGT_NO'
#CrmAsMgt_v2@UpdateShareFlag
--CrmAsMgt_v2@UpdateShareFlag  UPDATE CRM_AS_MST_SHARE     SET EXCEPT_YN ='Y'   WHERE MNGT_NO ='@MNGT_NO'
#CrmAsMgt_v2@UpdateWorkDetail
--CrmAsMgt_v2@UpdateWorkDetail Update CRM_AS_MST_WORKSet  USR_ID = '@USR_ID'  	,CONTENT='@CONTENT' 	,DEV_CONTENT='@DEV_CONTENT' 	,PROC_TYPE='@PROC_TYPE'	,TEST_RESULT = '@TEST_RESULT'	,SEQ = CASE WHEN '@USR_ID' = '@ORG_USR_ID'	            THEN @SEQ	            ELSE 	                 NVL((SELECT NVL(MAX(SEQ),0)	                        FROM CRM_AS_MST_WORK	                       WHERE MNGT_NO = '@MNGT_NO'	                         AND USR_ID = '@USR_ID'	                         AND SEQ <> 0 ) ,0)+1	            ENDWhere	MNGT_NO = '@MNGT_NO'AND USR_ID = '@ORG_USR_ID'AND SEQ = @SEQ	
