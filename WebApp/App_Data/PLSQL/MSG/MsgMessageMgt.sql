#MsgMessageMgt@CreateTable
CREATE TABLE MSG_MESSAGE_MST(  MSG_ID         VARCHAR2(20 CHAR),  DOMAIN         VARCHAR2(30 CHAR),  SENDER         VARCHAR2(50 CHAR),  SYS_TYPE        VARCHAR2(3 CHAR),  MSG_TYPE       VARCHAR2(1 CHAR),  JOB_TYPE       VARCHAR2(10 CHAR),  MSG            VARCHAR2(500 CHAR),  FIRST_MSGID    VARCHAR2(20 CHAR),  PARENT_MSG_ID  VARCHAR2(20 CHAR),  KEY1           VARCHAR2(50 CHAR),  KEY2           VARCHAR2(50 CHAR),  KEY3           VARCHAR2(50 CHAR),  KEY4           VARCHAR2(50 CHAR),  KEY5           VARCHAR2(50 CHAR),  DB_TIMESTAMP   VARCHAR2(20 CHAR)              DEFAULT to_char(systimestamp, 'YYYYMMDDHHMISSFF3'),  PRIMARY KEY  (MSG_ID)  ENABLE VALIDATE)LOGGING NOCOMPRESS NOCACHENOPARALLELMONITORING;COMMENT ON COLUMN MSG_MESSAGE_MST.MSG_ID IS '메세지번호';COMMENT ON COLUMN MSG_MESSAGE_MST.DOMAIN IS '도메인';COMMENT ON COLUMN MSG_MESSAGE_MST.SENDER IS '전송자(E-MAIL또는USR_ID)';COMMENT ON COLUMN MSG_MESSAGE_MST.SYS_TYPE IS '시스템구분 (W:WEB, E:ELVIS)';COMMENT ON COLUMN MSG_MESSAGE_MST.MSG_TYPE IS '메세지구분 (C:CHAT, P:PUSH, M:MESSAGE)';COMMENT ON COLUMN MSG_MESSAGE_MST.JOB_TYPE IS '업무구분 (공통코드:MSG01 / USR:회원가입 등등)';COMMENT ON COLUMN MSG_MESSAGE_MST.MSG IS '메시지내용';COMMENT ON COLUMN MSG_MESSAGE_MST.FIRST_MSGID IS '최초메세지번호';COMMENT ON COLUMN MSG_MESSAGE_MST.PARENT_MSG_ID IS '답장에 대한 원본 메시지 ID (채팅, 사내메신저)';COMMENT ON COLUMN MSG_MESSAGE_MST.KEY1 IS '레퍼런스번호1';COMMENT ON COLUMN MSG_MESSAGE_MST.KEY2 IS '레퍼런스번호2';COMMENT ON COLUMN MSG_MESSAGE_MST.KEY3 IS '레퍼런스번호3';COMMENT ON COLUMN MSG_MESSAGE_MST.KEY4 IS '레퍼런스번호4';COMMENT ON COLUMN MSG_MESSAGE_MST.KEY5 IS '레퍼런스번호5';CREATE TABLE MSG_MESSAGE_DTL(  MSGID     VARCHAR2(20 CHAR),  RECEIVER  VARCHAR2(50 CHAR),  READ_YN   VARCHAR2(1 CHAR)                    DEFAULT 'N',  READDATE  VARCHAR2(14 CHAR),  PRIMARY KEY  (MSGID, RECEIVER)  ENABLE VALIDATE)LOGGING NOCOMPRESS NOCACHENOPARALLELMONITORING;COMMENT ON COLUMN MSG_MESSAGE_DTL.MSGID IS '메세지번호';COMMENT ON COLUMN MSG_MESSAGE_DTL.RECEIVER IS '수신자';COMMENT ON COLUMN MSG_MESSAGE_DTL.READ_YN IS '열람여부';COMMENT ON COLUMN MSG_MESSAGE_DTL.READDATE IS '열람시간';
#MsgMessageMgt@DeleteAuth_20191117
--MsgMessageMgt@DeleteAuthDELETE   FROM MDM_COM_CODE WHERE GRP_CD = '@GRP_CD'   AND COMN_CD = '@COMN_CD'
#MsgMessageMgt@DeleteChatDtl
--MsgMessageMgt@DeleteChatDtlDELETE   FROM MSG_MESSAGE_DTL A WHERE NOT A.RECEIVER = '@RECEIVER'   AND EXISTS (SELECT '' FROM MSG_MESSAGE_MST Z WHERE Z.MSG_ID = A.MSG_ID AND Z.FIRST_MSG_ID = '@FIRST_MSG_ID')   --DTL 자료가 1개 이상인 경우만 처리   AND 1 < (SELECT COUNT(*) FROM MSG_MESSAGE_DTL Z WHERE Z.MSG_ID = A.MSG_ID AND EXISTS (SELECT '' FROM MSG_MESSAGE_MST Z WHERE Z.MSG_ID = A.MSG_ID AND Z.FIRST_MSG_ID = '@FIRST_MSG_ID'))
#MsgMessageMgt@GetMessageKey
--MsgMessageMgt@GetMessageKeySELECT TO_CHAR(CURRENT_TIMESTAMP, 'yyyyMMddhh24missff4')||ROUND(DBMS_RANDOM.VALUE(10, 99),0) AS MSG_ID     --, MESSAGE_SEQ.NEXTVAL AS SEQ      --, (SELECT NVL(MAX(SEQ),0)+1 FROM MSG_MESSAGE_MST WHERE MSG_ID = TO_CHAR(CURRENT_TIMESTAMP, 'yyyyMMddhh24missff4')) AS SEQ  FROM DUAL
#MsgMessageMgt@GetNoReadChatting
--MsgMessageMgt@GetNoReadChattingSELECT MST.MSG_ID     , MST.FIRST_MSG_ID     , MST.SYS_TYPE     , MST.SENDER     , TO_CHAR(TO_DATE(SUBSTR(MST.MSG_ID,1,14), 'yyyyMMddhh24miss'),'yyyy-MM-dd hh24:mi:ss') AS MSG_DATE     , TO_CHAR(TO_DATE(SUBSTR(MST.MSG_ID,1,14), 'yyyyMMddhh24miss'),'MM/dd hh24:mi')||CHR(13)||CHR(10)||MST.MSG AS MSG  FROM MSG_MESSAGE_MST MST WHERE MST.SYS_TYPE IN ('WE','EW')   AND MST.MSG_TYPE = 'C'   AND MST.FIRST_MSG_ID = '@FIRST_MSG_ID' --ORDER BY MSG_ID ASC ORDER BY DB_TIMESTAMP ASC
#MsgMessageMgt@GetNoReadChattingList
--MsgMessageMgt@GetNoReadChattingListSELECT MST.MSG_ID     , MST.FIRST_MSG_ID     , MST.SYS_TYPE     , MST.SENDER     , TO_CHAR(TO_DATE(SUBSTR(MST.MSG_ID,1,14), 'yyyyMMddhh24miss'),'yyyy-MM-dd hh24:mi:ss') AS MSG_DATE     , TO_CHAR(TO_DATE(SUBSTR(MST.MSG_ID,1,14), 'yyyyMMddhh24miss'),'yyyy-MM-dd hh24:mi:ss')||'  '||MST.SENDER||CHR(13)||CHR(10)||MST.MSG AS MSG  FROM MSG_MESSAGE_MST MST       INNER JOIN MSG_MESSAGE_DTL DTL               ON MST.MSG_ID = DTL.MSG_ID  WHERE MST.SYS_TYPE = 'WE'   AND MST.MSG_TYPE = 'C'   AND MST.MSG_ID = MST.FIRST_MSG_ID   AND DTL.RECEIVER = '@RECEIVER'   AND DTL.READ_YN = '@READ_YN'  ORDER BY MST.MSG_ID   
#MsgMessageMgt@GetNoReadMessage
--MsgMessageMgt@GetNoReadMessageSELECT MST.MSG_ID     , NVL(UFN_TABLE_ITEM('USER_NM',MST.SENDER,'L',''),UFN_TABLE_ITEM('USER_NM',MST.SENDER,'L','')) || ' - ' || TO_CHAR(TO_DATE(SUBSTR(MST.MSG_ID,1,14), 'yyyyMMddhh24miss'),'yyyy-MM-dd hh24:mi:ss') AS SENDER     , MST.MSG     , MST.JOB_TYPE     --MSG_TAG 변경시 프로그램과 함게 변경해야함     , MST.MSG_ID||'|'||MST.DOMAIN||'|'||MST.SENDER||'|'||MST.SYS_TYPE||'|'||MST.MSG_TYPE||'|'||MST.JOB_TYPE||'|'||MST.MSG||'|'||MST.FIRST_MSG_ID||'|'||MST.PARENT_MSG_ID||'|'||MST.KEY1||'|'||MST.KEY2||'|'||MST.KEY3||'|'||MST.KEY4||'|'||MST.KEY5||'|'||COM.OPT_ITEM1 AS MSG_TAG  FROM MSG_MESSAGE_MST MST       INNER JOIN MSG_MESSAGE_DTL DTL               ON MST.MSG_ID = DTL.MSG_ID        LEFT OUTER JOIN MDM_COM_CODE COM               ON COM.GRP_CD = 'MSG01'              AND COM.COMN_CD = MST.JOB_TYPE WHERE MST.SYS_TYPE IN ('EE','WE')   AND MST.MSG_TYPE = 'P'   AND DTL.RECEIVER = '@RECEIVER'   AND DTL.READ_YN = '@READ_YN'  ORDER BY MST.MSG_ID   
#MsgMessageMgt@GetNoReadMessageCount
--MsgMessageMgt@GetNoReadMessageCountSELECT COUNT(DTL.READ_YN) AS MSG_CNT  FROM MSG_MESSAGE_MST MST       INNER JOIN MSG_MESSAGE_DTL DTL               ON MST.MSG_ID = DTL.MSG_ID        LEFT OUTER JOIN MDM_COM_CODE COM               ON COM.GRP_CD = 'MSG01'              AND COM.COMN_CD = MST.JOB_TYPE WHERE MST.SYS_TYPE IN ('EE','WE')   AND MST.MSG_TYPE = 'P'   AND DTL.RECEIVER = '@RECEIVER'   AND DTL.READ_YN = '@READ_YN' 
#MsgMessageMgt@Save
--MsgMessageMgt@SaveINSERT INTO MSG_MESSAGE_MST(     MSG_ID     ,DOMAIN    ,SENDER    ,SYS_TYPE    ,MSG_TYPE    ,JOB_TYPE    ,MSG    ,FIRST_MSG_ID    ,PARENT_MSG_ID    ,KEY1    ,KEY2    ,KEY3    ,KEY4    ,KEY5)VALUES('@MSG_ID'	  ,'@DOMAIN'	  ,'@SENDER'	  ,'@SYS_TYPE'	  ,'@MSG_TYPE'	  ,'@JOB_TYPE'	  ,'@MSG'	  ,'@FIRST_MSG_ID'	  ,'@PARENT_MSG_ID'	  ,'@KEY1'	  ,'@KEY2'	  ,'@KEY3'	  ,'@KEY4'	  ,'@KEY5')
#MsgMessageMgt@SaveAuth_20191117
--MsgMessageMgt@SaveAuthINSERT INTO MDM_COM_CODE (GRP_CD                        , COMN_CD                        , CD_NM                        , OPT_ITEM1                        , OPT_ITEM2                        , INS_USR                        , INS_YMD                        , INS_HM                        , UPD_USR                        , UPD_YMD                        , UPD_HM                          )   SELECT '@GRP_CD'        , SUBSTR ('000'||(TO_NUMBER(NVL(MAX(COMN_CD),0))+ 1),-3) AS COMN_CD        , '@CD_NM'        , '@OPT_ITEM1'        , '@OPT_ITEM2'        , '@USR_ID'		, UFN_DATE_FORMAT('DATE')		, UFN_DATE_FORMAT('TIME')        , '@USR_ID'		, UFN_DATE_FORMAT('DATE')		, UFN_DATE_FORMAT('TIME')     FROM MDM_COM_CODE    WHERE COMN_CD < '9' AND LENGTH (COMN_CD) = 3 AND GRP_CD = 'MSG03'
#MsgMessageMgt@SaveComplete
--MsgMessageMgt@SaveCompleteUPDATE MSG_MESSAGE_DTL   SET READ_YN = 'Y'      ,READ_DATE = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS') WHERE MSG_ID = '@MSG_ID'
#MsgMessageMgt@SaveDetail
--MsgMessageMgt@SaveDetailINSERT INTO MSG_MESSAGE_DTL(     MSG_ID     ,RECEIVER    ,READ_YN    ,READ_DATE)VALUES('@MSG_ID'	  ,'@RECEIVER'	  ,'@READ_YN'	  ,'@READ_DATE')
#MsgMessageMgt@Search
--MsgMessageMgt@SearchSELECT MST.MSG_ID      ,MST.DOMAIN      ,MST.SENDER      ,UFN_TABLE_ITEM('USER_NM',MST.SENDER,'L','') AS SENDER_NM      ,TO_CHAR(TO_DATE(SUBSTR(MST.MSG_ID,1,14),'yyyyMMddhh24miss'),'yyyy-MM-dd hh24:mi:ss') AS SEND_DATE      ,MST.SYS_TYPE      ,(SELECT MAX(Z.CD_NM) FROM MDM_COM_CODE Z WHERE Z.GRP_CD = 'R10' AND Z.COMN_CD = MST.SYS_TYPE) AS SYS_TYPE_NM      ,MST.MSG_TYPE      ,(SELECT MAX(Z.CD_NM) FROM MDM_COM_CODE Z WHERE Z.GRP_CD = 'R11' AND Z.COMN_CD = MST.MSG_TYPE) AS MSG_TYPE_NM      ,MST.JOB_TYPE      ,COM.CD_NM AS JOB_TYPE_NM      ,MST.MSG      ,MST.FIRST_MSG_ID      ,MST.PARENT_MSG_ID      ,MST.KEY1      ,MST.KEY2      ,MST.KEY3      ,MST.KEY4      ,MST.KEY5    [SELECT_RECEIVED]      ,DTL.RECEIVER      ,NVL(DTL.READ_YN,'Y') AS READ_YN      ,DTL.READ_DATE    [/SELECT_RECEIVED]    [SELECT_SENT]      ,'' AS RECEIVER      ,'N' AS READ_YN      ,'' AS READ_DATE      --,(SELECT LISTAGG (RECEIVER, ';') WITHIN GROUP (ORDER BY RECEIVER)      --    FROM MSG_MESSAGE_DTL      --   WHERE MSG_ID = MST.MSG_ID      --     AND SEQ = MST.SEQ) AS RECEIVER_NM    [/SELECT_SENT]      ,COM.OPT_ITEM1 AS FORM_NM  FROM MSG_MESSAGE_MST MST      [SELECT_RECEIVED]       INNER JOIN MSG_MESSAGE_DTL DTL               ON MST.MSG_ID = DTL.MSG_ID     [/SELECT_RECEIVED]       LEFT OUTER JOIN MDM_COM_CODE COM               ON COM.GRP_CD = 'MSG01'              AND COM.COMN_CD = MST.JOB_TYPE WHERE MSG_TYPE IN ('P','M') [SELECT_RECEIVED]   [RECEIVER]     AND DTL.RECEIVER = '@RECEIVER'      [/RECEIVER]      [NOT NULL]     AND DTL.READ_YN = '@READ_YN'   [/NOT NULL]   [ISNULL]     AND (DTL.READ_YN IS NULL OR DTL.READ_YN = 'Y')   [/ISNULL] [/SELECT_RECEIVED] [SENDER]   AND MST.SENDER = '@SENDER' [/SENDER] [SEND_DATE]   AND MST.MSG_ID BETWEEN '@DATE_FROM' AND '@DATE_TO' [/SEND_DATE]ORDER BY MST.MSG_ID DESC
#MsgMessageMgt@SearchAuth_20191117
--MsgMessageMgt@SearchAuthSELECT GRP_CD,       COMN_CD,       CD_NM,       OPT_ITEM1,       OPT_ITEM2  FROM MDM_COM_CODE WHERE GRP_CD = 'MSG03' AND CD_NM = (SELECT EMAIL								       FROM MDM_USER_MST								      WHERE USR_ID = '@USR_ID')ORDER BY UPD_YMD, UPD_HM
#MsgMessageMgt@SearchAuthCheck_20191117
--MsgMessageMgt@SearchAuthCheckSELECT MST.GRP_CD,       MST.COMN_CD,       COM1.CD_NM AS OPT_ITEM1,       COM2.CD_NM AS OPT_ITEM2  FROM MDM_COM_CODE MST       LEFT OUTER JOIN MDM_COM_CODE COM1          ON COM1.GRP_CD = 'MSG01' AND COM1.COMN_CD = MST.OPT_ITEM1       LEFT OUTER JOIN MDM_COM_CODE COM2          ON COM2.GRP_CD = 'MSG02' AND COM2.COMN_CD = MST.OPT_ITEM2 WHERE     MST.GRP_CD = '@GRP_CD'       AND MST.CD_NM = '@CD_NM'       AND MST.OPT_ITEM1 = '@OPT_ITEM1'       AND MST.OPT_ITEM2 = '@OPT_ITEM2'
#MsgMessageMgt@SearchDetail
--MsgMessageMgt@SearchDetailSELECT MSG_ID     , RECEIVER     , READ_YN     , READ_DATE  FROM MSG_MESSAGE_DTL WHERE MSG_ID = '@MSG_ID'
#MsgMessageMgt@SearchRcv_Auth_20191117
--MsgMessageMgt@SearchRcv_AuthSELECT (SELECT EMAIL          FROM MDM_USER_MST         WHERE USR_ID = CD_NM)          AS CODE,       (SELECT LOC_NM          FROM MDM_USER_MST         WHERE USR_ID = CD_NM)          AS NAME  FROM MDM_COM_CODE WHERE GRP_CD = 'MSG03' AND COMN_CD LIKE 'A%'
#MsgMessageMgt@SearchSent_20191117
--MsgMessageMgt@SearchSentSELECT MST.MSG_ID      ,MST.SEQ      ,MST.DOMAIN      ,MST.SENDER      ,(SELECT MAX(ENG_NM) FROM MDM_USER_MST WHERE EMAIL = MST.SENDER) AS SENDER_NM      ,TO_CHAR(TO_DATE(SUBSTR(MST.MSG_ID,1,14),'yyyyMMddhh24miss'),'yyyy-MM-dd hh24:mi:ss') AS SEND_DATE      ,MST.SYS_TYPE      ,MST.MSG_TYPE      ,MST.JOB_TYPE      ,COM.CD_NM AS JOB_TYPE_NM      ,MST.MSG      ,MST.FIRST_MSG_ID      ,MST.PARENT_MSG_ID      ,MST.PARENT_SEQ      ,MST.KEY1      ,MST.KEY2      ,MST.KEY3      ,MST.KEY4      ,MST.KEY5      ,'' AS RECEIVER      ,'N' AS READ_YN      ,'' AS READ_DATE      ,(SELECT LISTAGG (RECEIVER, ';') WITHIN GROUP (ORDER BY RECEIVER)          FROM MSG_MESSAGE_DTL         WHERE MSG_ID = MST.MSG_ID           AND SEQ = MST.SEQ) AS RECEIVER_NM      ,COM.OPT_ITEM1 AS FORM_NM  FROM MSG_MESSAGE_MST MST LEFT OUTER JOIN MDM_COM_CODE COM      ON COM.GRP_CD = 'MSG01'      AND COM.COMN_CD = MST.JOB_TYPE WHERE MST.SENDER = '@SENDER'   AND MSG_TYPE IN ('P','M')[SEND_DATE]       AND MST.MSG_ID BETWEEN '@DATE_FROM' AND '@DATE_TO'[/SEND_DATE]ORDER BY MST.MSG_ID DESC
#MsgMessageMgt@SearchUser
--MsgMessageMgt@SearchUserSELECT USR.USR_ID,       USR.ENG_NM,       USR.LOC_NM,       USR.EMAIL  FROM CRM_USR_MST USR WHERE RECVMSG_YN = 'Y'
#MsgMessageMgt@UpdateAlert
--MsgMessageMgt@UpdateAlertUPDATE MSG_MESSAGE_DTL   SET READ_YN = 'Y'      ,READ_DATE = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS') + (CASE WHEN RECEIVER = '@RECEIVER' THEN -1 ELSE 0 END) WHERE MSG_ID = '@MSG_ID' 
#MsgMessageMgt@UpdateAuth_20191117
--MsgMessageMgt@UpdateAuthUPDATE MDM_COM_CODE    SET OPT_ITEM1	= '@OPT_ITEM1'     , OPT_ITEM2	= '@OPT_ITEM2'     , UPD_USR 		= '@EMPNO'	 , UPD_YMD      = TO_CHAR(SYSDATE,'YYYYMMDD')	 , UPD_HM		= TO_CHAR(SYSDATE,'HH24MI')WHERE  GRP_CD 		= '@GRP_CD'  AND  COMN_CD 		= '@COMN_CD'
#MsgMessageMgt@UpdateNoReadMessageCount
--MsgMessageMgt@UpdateNoReadMessageCountUPDATE MSG_MESSAGE_DTL[NOT NULL]   SET READ_YN = '@READ_YN'[/NOT NULL][ISNULL]   SET READ_YN = 'Y'      ,READ_DATE = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')[/ISNULL] WHERE MSG_ID = '@MSG_ID'   AND RECEIVER = '@RECEIVER'
