#EchSendList@Delete
-- EchSendList@DeleteDELETE ECH_SEND_STATUS WHERE USR_ID = '@USR_ID'
#EchSendList@InsertData
-- EchSendList@InsertDataINSERT INTO ECH_SEND_STATUS   SELECT '@USR_ID' AS USR_ID     , @SEQ+1 AS SEQ     , A.VENDOR     , B.OPT_ITEM1 AS REQ_SVC     , CASE WHEN @SEQ = 0 THEN 0 ELSE COUNT(DISTINCT A.CUST_CD) END AS CUST_CNT     , CASE WHEN @SEQ = 0 THEN SUM(A.SEND_CNT) ELSE 0 END AS SEND_CNT     , CASE WHEN @SEQ = 1 THEN SUM(A.SEND_CNT) ELSE 0 END AS SEND_CNT2     , 0 TOT_SEND_CNT FROM (        @BODY             ) A LEFT OUTER JOIN MDM_COM_CODE B           ON A.DOC_CD = B.COMN_CD           AND B.GRP_CD = 'Y01'WHERE 1=1GROUP BY A.VENDOR     , B.OPT_ITEM1 
#EchSendList@InsertData2
-- EchSendList@InsertData2	INSERT INTO ECH_SEND_STATUS   	SELECT '@USR_ID' AS USR_ID	     , 3 AS SEQ	     , A.VENDOR	     , '' AS REQ_SVC	     , 0  AS CUST_CNT	     , 0  AS SEND_CNT	     , 0  AS SEND_CNT2	     , COUNT(DISTINCT A.CUST_CD) TOT_SEND_CNT	 FROM (	        @BODY 	    ) A 	WHERE 1=1	GROUP BY A.VENDOR
#EchSendList@Search
-- EchSendList@SearchWITH T AS (	SELECT M_STPCODE, MAX(M_SSRID) AS M_SSRID	  FROM TTP_EDIFACT@ELVIS_CHAIN 	 WHERE SUBSTR(M_SSRID,1,2) = 'FS'	 GROUP BY M_STPCODE)   , T_CUST AS (    SELECT MAX(CUST_CD) AS CUST_CD    	 , MAX(CUST_LOC_NM) AS CUST_LOC_NM         , CHAIN_ID AS CUSTOMS_CD         , MAX(USE_YN) AS USE_YN      FROM CRM_CUST_MST     WHERE CHAIN_ID IS NOT NULL  GROUP BY CHAIN_ID), T_KCS AS (	SELECT M_STPCODE, MAX(M_SSRID) AS M_SSRID	  FROM TTP_EDIFACT@ELVIS_CHAIN 	 WHERE M_STPCODE = 'KLNET_KCS' AND M_SSTANDARD IN ('KLSEDIFACT','KLAEDIFACT')     	 GROUP BY M_STPCODE)SELECT *  FROM (	SELECT A.M_SSNDRTPCODE 	     , B.CUST_LOC_NM AS M_SSNDRTPNAME	     , C.M_SSRID	     , TO_CHAR(A.M_DSENDTIME,'yyyy-MM-dd') AS M_DSENDTIME	     , A.M_SDOCNAME   -- 문서코드 	     , A.M_SRCVRTPCODE	     , A.M_STXID	     , A.M_NTOSIZE	     , A.M_SDOCKEY	     , SUBSTR(A.M_SRCVRTPCODE,1,5) AS VENDOR         , CASE WHEN SUBSTR(A.M_SDOCNAME, 3, 3) = 'MOD'                THEN SUBSTR(A.M_SDOCKEY, 1, 11)                ELSE (SELECT MAX(M_SMRNNO)                        FROM ECH_SEASTAT_MST@ELVIS_CHAIN                       WHERE M_SMBL_NO = A.M_SDOCKEY                         AND M_STXID = A.M_STXID )           END AS MRNNO	          , '' AS M_SDO_NO         , '' AS M_SWH_RCVCD         , SO.M_SHBL_NO         , ROW_NUMBER() OVER (PARTITION BY A.M_STXID ORDER BY C.M_SSRID DESC) AS RNUM           	  FROM TTXSTAT@ELVIS_CHAIN A 	       LEFT OUTER JOIN T_CUST B	         ON A.M_SSNDRTPCODE = B.CUSTOMS_CD	        AND B.USE_YN = 'Y'	       LEFT OUTER JOIN T C	         ON A.M_SSNDRTPCODE = C.M_STPCODE	       LEFT OUTER JOIN ECH_SEASTAT_MST@ELVIS_CHAIN SO	       	 ON A.M_STXID = SO.M_STXID	 WHERE 1=1	   AND A.M_SRCVRTPCODE IN (SELECT COMN_CD FROM MDM_COM_CODE WHERE GRP_CD ='Y03')	   AND A.M_BSENDRESULT = 'T' 	   AND A.M_STXSTATUS = 'TS'	   AND A.M_DSENDTIME >= TO_DATE('@FM_YMD','yyyyMMdd')	   AND A.M_DSENDTIME < TO_DATE('@TO_YMD','yyyyMMdd')+1   	   AND A.M_SDOCNAME IN ('SOMFC', 'SIMFC', 'SOMOD', 'SIMOD')	   AND SUBSTR(C.M_SSRID,1,2) = 'FS'	         [CRM_CUST_CD]      		AND B.CUST_CD = '@CRM_CUST_CD'      [/CRM_CUST_CD]            [CUST_NM]      		AND B.CUST_LOC_NM LIKE '@CUST_NM%'      [/CUST_NM]      	UNION ALL	SELECT A.M_SSNDRTPCODE 	     , B.CUST_LOC_NM AS M_SSNDRTPNAME	     , C.M_SSRID	     , TO_CHAR(A.M_DSENDTIME,'yyyy-MM-dd') AS M_DSENDTIME	     , A.M_SDOCNAME   -- 문서코드 	     , A.M_SRCVRTPCODE	     , A.M_STXID	     , A.M_NTOSIZE	     , A.M_SDOCKEY	     , SUBSTR(A.M_SRCVRTPCODE,1,5) AS VENDOR         , CASE WHEN SUBSTR(A.M_SDOCNAME, 3, 3) = 'MOD'                THEN SUBSTR(A.M_SDOCKEY, 1, 11)                ELSE (SELECT MAX(M_SMRNNO)                        FROM ECH_AIRSTAT_MST@ELVIS_CHAIN                       WHERE M_SMBL_NO = A.M_SDOCKEY                         AND M_STXID = A.M_STXID )           END AS MRNNO           , AO.M_SDO_NO        , AO.M_SWH_RCVCD        , AO.M_SHBL_NO        , ROW_NUMBER() OVER (PARTITION BY A.M_STXID ORDER BY C.M_SSRID DESC) AS RNUM           	  FROM TTXSTAT@ELVIS_CHAIN A 	       LEFT OUTER JOIN T_CUST B	         ON A.M_SSNDRTPCODE = B.CUSTOMS_CD	        AND B.USE_YN = 'Y'	       LEFT OUTER JOIN TTP_EDIFACT@ELVIS_CHAIN C	         ON A.M_SSNDRTPCODE = C.M_STPCODE	       LEFT OUTER JOIN ECH_AIRSTAT_MST@ELVIS_CHAIN AO	       	 ON A.M_STXID = AO.M_STXID	 WHERE 1=1	   AND A.M_SRCVRTPCODE IN (SELECT COMN_CD FROM MDM_COM_CODE WHERE GRP_CD ='Y03')	   AND A.M_BSENDRESULT = 'T' 	   AND A.M_STXSTATUS = 'TS'	   AND A.M_DSENDTIME >= TO_DATE('@FM_YMD','yyyyMMdd')	   AND A.M_DSENDTIME < TO_DATE('@TO_YMD','yyyyMMdd')+1   	   AND A.M_SDOCNAME IN ('ARDCD', 'AIRDO', 'AIRDC', 'ARAMS', 'FWB', 'ICMOD', 'OCMOD', 'OMFCS')	   AND SUBSTR(C.M_SSRID,1,2) = 'FF'	         [CRM_CUST_CD]      		AND B.CUST_CD = '@CRM_CUST_CD'      [/CRM_CUST_CD]            [CUST_NM]      		AND B.CUST_LOC_NM LIKE '@CUST_NM%'      [/CUST_NM]      	UNION ALL	SELECT A.M_SSNDRTPCODE 	     , B.CUST_LOC_NM AS M_SSNDRTPNAME	     , '' AS M_SSRID	     , TO_CHAR(A.M_DSENDTIME,'yyyy-MM-dd') AS M_DSENDTIME	     , A.M_SDOCNAME   -- 문서코드 	     , A.M_SRCVRTPCODE	     , A.M_STXID	     , A.M_NTOSIZE	     , A.M_SDOCKEY	     , SUBSTR(A.M_SRCVRTPCODE,1,5) AS VENDOR         , '' AS MRNNO         , AO.M_SDO_NO         , AO.M_SWH_RCVCD         , CASE WHEN A.M_SDOCNAME IN ('ARDCD', 'AIRDO', 'AIRDC', 'ARAMS', 'FWB', 'ICMOD', 'OCMOD', 'OMFCS')          		THEN AO.M_SHBL_NO         		ELSE SO.M_SHBL_NO END AS M_SHBL_NO         , 1 AS RNUM         	  FROM TTXSTAT@ELVIS_CHAIN A 	       LEFT OUTER JOIN T_CUST B	         ON A.M_SSNDRTPCODE = B.CUSTOMS_CD	        AND B.USE_YN = 'Y'	       LEFT OUTER JOIN ECH_AIRSTAT_MST@ELVIS_CHAIN AO	       	 ON A.M_STXID = AO.M_STXID	       LEFT OUTER JOIN ECH_SEASTAT_MST@ELVIS_CHAIN SO	       	 ON A.M_STXID = SO.M_STXID	 WHERE 1=1	   AND A.M_SRCVRTPCODE IN (SELECT COMN_CD FROM MDM_COM_CODE WHERE GRP_CD ='Y03')	   AND A.M_BSENDRESULT = 'T' 	   AND A.M_STXSTATUS = 'TS'	   AND A.M_DSENDTIME >= TO_DATE('@FM_YMD','yyyyMMdd')	   AND A.M_DSENDTIME < TO_DATE('@TO_YMD','yyyyMMdd')+1   	   AND A.M_SDOCNAME NOT IN ('SOMFC', 'SIMFC', 'SOMOD', 'SIMOD','ARDCD', 'AIRDO', 'AIRDC', 'ARAMS', 'FWB', 'ICMOD', 'OCMOD', 'OMFCS')	         [CRM_CUST_CD]      		AND B.CUST_CD = '@CRM_CUST_CD'      [/CRM_CUST_CD]            [CUST_NM]      		AND B.CUST_LOC_NM LIKE '@CUST_NM%'      [/CUST_NM]      	UNION ALL	SELECT D.M_SSNDRTPCODE  	     , E.CUST_LOC_NM AS M_SSNDRTPNAME 	     , F.M_SSRID 	     , TO_CHAR(D.M_DSENDTIME,'yyyy-MM-dd') AS M_DSENDTIME 	     , D.M_SDOCNAME   -- 문서코드  	     , D.M_SRCVRTPCODE 	     , D.M_STXID 	     , D.M_NTOSIZE 	     , D.M_SDOCKEY 	     , SUBSTR(D.M_SRCVRTPCODE,1,5) AS VENDOR          , SUBSTR(D.M_SDOCKEY, 1, 11) AS MRNNO         , AO.M_SDO_NO         , AO.M_SWH_RCVCD         , CASE WHEN D.M_SDOCNAME IN ('ARDCD', 'AIRDO', 'AIRDC', 'ARAMS', 'FWB', 'ICMOD', 'OCMOD', 'OMFCS')          		THEN AO.M_SHBL_NO         		ELSE SO.M_SHBL_NO END AS M_SHBL_NO         , 1 AS RNUM         	  FROM TTXSTAT@ELVIS_CHAIN D  	       LEFT OUTER JOIN T_CUST E 	         ON D.M_SRCVRTPCODE = E.CUSTOMS_CD 	        AND E.USE_YN = 'Y' 	       LEFT OUTER JOIN T_KCS F 	         ON D.M_SRCVRTPCODE = F.M_STPCODE	       LEFT OUTER JOIN ECH_AIRSTAT_MST@ELVIS_CHAIN AO	       	 ON D.M_STXID = AO.M_STXID 	       LEFT OUTER JOIN ECH_SEASTAT_MST@ELVIS_CHAIN SO	       	 ON D.M_STXID = SO.M_STXID 	 WHERE 1=1 	   AND  D.M_SSNDRTPCODE IN ('KLNET_KCS')  	   AND D.M_STXSTATUS = 'TS' 	   AND D.M_DSENDTIME >= TO_DATE('@FM_YMD','yyyyMMdd') 	   AND D.M_DSENDTIME < TO_DATE('@TO_YMD','yyyyMMdd')+1 	   AND D.M_SDOCNAME ='CUSAPE' 	  [CUST_CD]	   		AND SUBSTR(D.M_SRCVRTPCODE,1,5) = '@CUST_CD'	  [/CUST_CD]	         [CRM_CUST_CD]      		AND E.CUST_CD = '@CRM_CUST_CD'      [/CRM_CUST_CD]            [CUST_NM]      		AND E.CUST_LOC_NM LIKE '@CUST_NM%'      [/CUST_NM]) AWHERE 1=1[CUST_CD]   AND A.M_SSNDRTPCODE IN('@CUST_CD', 'KLNET_KCS')[/CUST_CD][DOC_CD]   AND A.M_SDOCNAME = '@DOC_CD'[/DOC_CD][MFCS]   AND A.M_SDOCNAME IN ('SOMFC', 'SIMFC', 'SOMOD', 'SIMOD','ARDCD', 'AIRDO', 'AIRDC', 'ARAMS', 'FWB', 'ICMOD', 'OCMOD', 'OMFCS')[/MFCS][AFR]   AND A.M_SDOCNAME IN ('SOAHR', 'SOCMP', 'SOCMV', 'SOCHR', 'SOBLL')[/AFR]   AND A.RNUM = 1ORDER BY A.M_SSNDRTPCODE,A.M_DSENDTIME 
#EchSendList@SearchCustCnt
--EchSendList@SearchCustCnt
SELECT NVL(COUNT(*),0) AS ECH_CUST_CNT
  FROM CRM_CUST_MST 
 WHERE CHAIN_ID IS NOT NULL
   AND USE_YN = 'Y'
   AND CHAIN_START_YMD <= TO_CHAR(SYSDATE,'YYYYMMDD')
   AND CHAIN_END_YMD IS NULL
#EchSendList@SearchStatus
-- EchSendList@SearchStatus    SELECT A.VENDOR         , SUM(A.SEA_SEND_CNT) 	AS SEA_SEND_CNT         , SUM(A.AIR_SEND_CNT) 	AS AIR_SEND_CNT           , SUM(A.AMS_SEND_CNT) 	AS AMS_SEND_CNT         , SUM(A.SEA_SEND_CNT+A.AIR_SEND_CNT+A.AMS_SEND_CNT) AS TOT_SEND_CNT         , SUM(A.SEA_SEND_CNT2) AS SEA_SEND_CNT2         , SUM(A.AIR_SEND_CNT2) AS AIR_SEND_CNT2          , SUM(A.AMS_SEND_CNT2) AS AMS_SEND_CNT2         , SUM(A.SEA_SEND_CNT2+A.AIR_SEND_CNT2+A.AMS_SEND_CNT2) AS TOT_SEND_CNT2         , SUM(A.SEA_CUST_CNT)  AS SEA_CUST_CNT         , SUM(A.AIR_CUST_CNT)  AS AIR_CUST_CNT          , SUM(A.AMS_CUST_CNT)  AS AMS_CUST_CNT         , SUM(A.SEA_CUST_CNT+A.AIR_CUST_CNT+A.AMS_CUST_CNT) AS TOT_CUST_CNT         --, SUM(A.TOT_CUST_CNT)  AS TOT_CUST_CNT     FROM (                            SELECT B.SEQ                 , CASE WHEN A.VENDOR IN ('KLNET','KTNET','KCNET') THEN A.VENDOR ELSE 'KLNET' END AS VENDOR                 , CASE WHEN B.SEQ = 1 AND A.REQ_SVC = 'SEA' THEN A.SEND_CNT ELSE 0 END AS SEA_SEND_CNT                 , CASE WHEN B.SEQ = 2 AND A.REQ_SVC = 'AIR' THEN A.SEND_CNT ELSE 0 END AS AIR_SEND_CNT                 , CASE WHEN B.SEQ = 3 AND A.REQ_SVC = 'AMS' THEN A.SEND_CNT ELSE 0 END AS AMS_SEND_CNT                 , 0 AS SEA_SEND_CNT2                 , 0 AS AIR_SEND_CNT2                 , 0 AS AMS_SEND_CNT2                 , 0 AS SEA_CUST_CNT                 , 0 AS AIR_CUST_CNT                 , 0 AS AMS_CUST_CNT                 , 0 AS TOT_CUST_CNT              FROM ECH_SEND_STATUS A                 , MDM_LOOP B             WHERE A.USR_ID = '@USR_ID'               AND A.SEQ = 1               AND B.SEQ < 4                           UNION ALL                           SELECT B.SEQ                 , CASE WHEN A.VENDOR IN ('KLNET','KTNET','KCNET') THEN A.VENDOR ELSE 'KLNET' END AS VENDOR                 , 0 AS SEA_SEND_CNT                 , 0 AS AIR_SEND_CNT                 , 0 AS SEA_SEND_CNT                 , CASE WHEN B.SEQ = 1 AND A.REQ_SVC = 'SEA' THEN A.SEND_CNT2 ELSE 0 END AS SEA_SEND_CNT2                  , CASE WHEN B.SEQ = 2 AND A.REQ_SVC = 'AIR' THEN A.SEND_CNT2 ELSE 0 END AS AIR_SEND_CNT2                 , CASE WHEN B.SEQ = 3 AND A.REQ_SVC = 'AMS' THEN A.SEND_CNT2 ELSE 0 END AS SEA_SEND_CNT2                 , CASE WHEN B.SEQ = 1 AND A.REQ_SVC = 'SEA' THEN A.CUST_CNT ELSE 0 END AS SEA_CUST_CNT                  , CASE WHEN B.SEQ = 2 AND A.REQ_SVC = 'AIR' THEN A.CUST_CNT ELSE 0 END AS AIR_CUST_CNT                 , CASE WHEN B.SEQ = 3 AND A.REQ_SVC = 'AMS' THEN A.CUST_CNT ELSE 0 END AS AMS_CUST_CNT                 , 0 AS TOT_CUST_CNT              FROM ECH_SEND_STATUS A                 , MDM_LOOP B             WHERE A.USR_ID = '@USR_ID'               AND A.SEQ = 2               AND B.SEQ < 4            UNION ALL               SELECT 0 AS SEQ                 , CASE WHEN A.VENDOR IN ('KLNET','KTNET','KCNET') THEN A.VENDOR ELSE 'KLNET' END AS VENDOR                 , 0 AS SEA_SEND_CNT                 , 0 AS AIR_SEND_CNT                 , 0 AS SEA_SEND_CNT                 , 0 AS SEA_SEND_CNT2                  , 0 AS AIR_SEND_CNT2                 , 0 AS SEA_SEND_CNT2                 , 0 AS SEA_CUST_CNT                  , 0 AS AIR_CUST_CNT                 , 0 AS AMS_CUST_CNT                 , A.TOT_CUST_CNT              FROM ECH_SEND_STATUS A             WHERE A.USR_ID = '@USR_ID'               AND A.SEQ = 3        ) A        GROUP BY A.VENDOR
#EchSendList@SearchSummary
-- EchSendList@SearchSummaryWITH T AS (SELECT M_STPCODE, MAX(M_SSRID) AS M_SSRID  FROM TTP_EDIFACT@ELVIS_CHAIN  WHERE SUBSTR(M_SSRID,1,2) = 'FS' GROUP BY M_STPCODE)   , T_CUST AS (    SELECT MAX(CUST_CD) AS CUST_CD    	 , MAX(CUST_LOC_NM) AS CUST_LOC_NM         , CHAIN_ID AS CUSTOMS_CD         , MAX(USE_YN) AS USE_YN      FROM CRM_CUST_MST     WHERE CHAIN_ID IS NOT NULL  GROUP BY CHAIN_ID), T_KCS AS (	SELECT M_STPCODE, MAX(M_SSRID) AS M_SSRID	  FROM TTP_EDIFACT@ELVIS_CHAIN 	 WHERE M_STPCODE = 'KLNET_KCS' AND M_SSTANDARD IN ('KLSEDIFACT','KLAEDIFACT')     	 GROUP BY M_STPCODE)SELECT *  FROM (	SELECT A.CUST_CD	     , A.CUST_NM	     , C.M_SSRID AS CUST_ID	     , A.DOC_CD	     , A.DOC_CD2	     , B.CD_NM AS DOC_NM	     , A.VENDOR	     , A.SEND_CNT	     , A.SEND_SIZE	     , CASE WHEN A.CUST_RATE = 0 	            THEN A.VENDOR_RATE	            ELSE A.CUST_RATE	       END AS CUST_RATE     	     , CASE WHEN A.CUST_DC_RATE = 0 	            THEN A.VENDOR_DC_RATE	            ELSE A.CUST_DC_RATE	       END AS CUST_DC_RATE     	     , CASE WHEN A.CUST_RATE = 0 	            THEN ROUND(A.VENDOR_RATE * A.SEND_SIZE * 						       CASE WHEN A.CUST_DC_RATE = 0 						            THEN A.VENDOR_DC_RATE						            ELSE A.CUST_DC_RATE						        END,0)	            ELSE ROUND(A.CUST_RATE * A.SEND_SIZE * 						       CASE WHEN A.CUST_DC_RATE = 0 						            THEN A.VENDOR_DC_RATE						            ELSE A.CUST_DC_RATE						        END,0)	       END AS CUST_AMT	     , A.VENDOR_RATE	     , A.VENDOR_DC_RATE	     , CASE WHEN A.VENDOR_DC_RATE = 0 	            THEN ROUND(A.VENDOR_RATE * A.SEND_SIZE,0)	            ELSE ROUND(A.VENDOR_RATE * A.SEND_SIZE * A.VENDOR_DC_RATE,0)	       END AS VENDOR_AMT 	     , A.VENDOR_TYPE  	     , ROW_NUMBER() OVER (PARTITION BY A.M_STXID ORDER BY A.CUST_CD DESC) AS RNUM	  FROM (	        SELECT A.CUST_CD	             , MAX(B.CUST_LOC_NM) AS CUST_NM	             , A.DOC_CD	             , MAX(A.DOC_CD2) AS DOC_CD2	             , A.VENDOR	             , SUM(A.SEND_CNT)  AS SEND_CNT	             , ROUND(NVL(SUM(A.SEND_SIZE),0)/1024,0) AS SEND_SIZE	             , NVL(MAX(C.UNIT_PRC),0)  AS CUST_RATE	             , NVL(MAX(C.DC_RATE),0)  AS CUST_DC_RATE	             , CASE WHEN A.VENDOR = 'KLNET' THEN NVL(MAX(D.KLNET),0)	                    WHEN A.VENDOR = 'KTNET' THEN NVL(MAX(D.KTNET),0)	                    WHEN A.VENDOR = 'KCNET' THEN NVL(MAX(D.KCNET),0)	                    ELSE 0	               END AS VENDOR_RATE     	             , CASE WHEN A.VENDOR = 'KLNET' THEN MAX(D.KLNET_TYPE)	                    WHEN A.VENDOR = 'KTNET' THEN MAX(D.KTNET_TYPE)	                    WHEN A.VENDOR = 'KCNET' THEN MAX(D.KCNET_TYPE)	                    ELSE ''	               END AS VENDOR_TYPE     	             , CASE WHEN A.VENDOR = 'KLNET' THEN NVL(MAX(D.KLNET_DC_RATE),0)	                    WHEN A.VENDOR = 'KTNET' THEN NVL(MAX(D.KTNET_DC_RATE),0)	                    WHEN A.VENDOR = 'KCNET' THEN NVL(MAX(D.KCNET_DC_RATE),0)	                    ELSE 0	               END AS VENDOR_DC_RATE 	             , MAX(A.M_STXID) AS M_STXID	          FROM (	                SELECT A.M_SSNDRTPCODE             AS CUST_CD	                     , A.M_SDOCNAME        	       AS DOC_CD	                     , A2.CD_NM                    AS DOC_CD2	                     , SUBSTR(A.M_SRCVRTPCODE,1,5) AS VENDOR	                     , 1                   		   AS SEND_CNT	                     , A.M_NTOSIZE                 AS SEND_SIZE	                     , A.M_STXID	                  FROM TTXSTAT@ELVIS_CHAIN A 	                       LEFT OUTER JOIN MDM_COM_CODE A2	                            ON A.M_SDOCNAME = A2.COMN_CD	                           AND A2.GRP_CD = 'Y04'					 WHERE 1=1					   AND A.M_SRCVRTPCODE IN (SELECT COMN_CD FROM MDM_COM_CODE WHERE GRP_CD ='Y03')					   AND A.M_BSENDRESULT = 'T' 					   AND A.M_STXSTATUS = 'TS'					   AND A.M_DSENDTIME >= TO_DATE('@FM_YMD','yyyyMMdd')					   AND A.M_DSENDTIME < TO_DATE('@TO_YMD','yyyyMMdd')+1					   AND A.M_SDOCNAME IN ('SOMFC', 'SIMFC', 'SOMOD', 'SIMOD')					   [CUST_CD]					      AND A.M_SSNDRTPCODE = '@CUST_CD'					   [/CUST_CD]					   [DOC_CD]					      AND A.M_SDOCNAME = '@DOC_CD'					   [/DOC_CD]					   [VENDOR]					      AND A.M_SRCVRTPCODE LIKE '@VENDOR%'					   [/VENDOR]	              ) A LEFT OUTER JOIN T_CUST B	                    ON A.CUST_CD = B.CUSTOMS_CD AND B.USE_YN = 'Y'	                  LEFT OUTER JOIN ECH_CUST_TARIFF C	                    ON A.CUST_CD = C.CUST_CD	                   AND A.DOC_CD = C.DOC_CD	                   AND A.VENDOR = C.VENDOR        	                  LEFT OUTER JOIN ECH_VENDOR_TARIFF D	                    ON A.DOC_CD = D.DOC_CD            WHERE 1 = 1			[CRM_CUST_CD]				AND B.CUST_CD = '@CRM_CUST_CD'			[/CRM_CUST_CD]						[CUST_NM]			  	AND B.CUST_LOC_NM LIKE '@CUST_NM%'			[/CUST_NM]				          GROUP BY A.CUST_CD,A.DOC_CD,A.VENDOR	      ) A	      LEFT OUTER JOIN MDM_COM_CODE B	           ON A.DOC_CD = B.COMN_CD 	          AND B.GRP_CD = 'Y01'	      LEFT OUTER JOIN T C	         ON A.CUST_CD = C.M_STPCODE	WHERE SUBSTR(C.M_SSRID,1,2) = 'FS'	UNION ALL	SELECT A.CUST_CD	     , A.CUST_NM	     , C.M_SSRID AS CUST_ID	     , A.DOC_CD	     , A.DOC_CD2	     , B.CD_NM AS DOC_NM	     , A.VENDOR	     , A.SEND_CNT	     , A.SEND_SIZE	     , CASE WHEN A.CUST_RATE = 0 	            THEN A.VENDOR_RATE	            ELSE A.CUST_RATE	       END AS CUST_RATE     	     , CASE WHEN A.CUST_DC_RATE = 0 	            THEN A.VENDOR_DC_RATE	            ELSE A.CUST_DC_RATE	       END AS CUST_DC_RATE     	     , CASE WHEN A.CUST_RATE = 0 	            THEN ROUND(A.VENDOR_RATE * A.SEND_SIZE * 						       CASE WHEN A.CUST_DC_RATE = 0 						            THEN A.VENDOR_DC_RATE						            ELSE A.CUST_DC_RATE						        END,0)	            ELSE ROUND(A.CUST_RATE * A.SEND_SIZE * 						       CASE WHEN A.CUST_DC_RATE = 0 						            THEN A.VENDOR_DC_RATE						            ELSE A.CUST_DC_RATE						        END,0)	       END AS CUST_AMT	     , A.VENDOR_RATE	     , A.VENDOR_DC_RATE	     , CASE WHEN A.VENDOR_DC_RATE = 0 	            THEN ROUND(A.VENDOR_RATE * A.SEND_SIZE,0)	            ELSE ROUND(A.VENDOR_RATE * A.SEND_SIZE * A.VENDOR_DC_RATE,0)	       END AS VENDOR_AMT 	     , A.VENDOR_TYPE  	     , ROW_NUMBER() OVER (PARTITION BY A.M_STXID ORDER BY A.CUST_CD DESC) AS RNUM	  FROM (	        SELECT A.CUST_CD	             , MAX(B.CUST_LOC_NM) AS CUST_NM	             , A.DOC_CD	             , MAX(A.DOC_CD2) AS DOC_CD2	             , A.VENDOR	             , SUM(A.SEND_CNT)  AS SEND_CNT	             , ROUND(NVL(SUM(A.SEND_SIZE),0)/1024,0) AS SEND_SIZE	             , NVL(MAX(C.UNIT_PRC),0)  AS CUST_RATE	             , NVL(MAX(C.DC_RATE),0)  AS CUST_DC_RATE	             , CASE WHEN A.VENDOR = 'KLNET' THEN NVL(MAX(D.KLNET),0)	                    WHEN A.VENDOR = 'KTNET' THEN NVL(MAX(D.KTNET),0)	                    WHEN A.VENDOR = 'KCNET' THEN NVL(MAX(D.KCNET),0)	                    ELSE 0	               END AS VENDOR_RATE     	             , CASE WHEN A.VENDOR = 'KLNET' THEN MAX(D.KLNET_TYPE)	                    WHEN A.VENDOR = 'KTNET' THEN MAX(D.KTNET_TYPE)	                    WHEN A.VENDOR = 'KCNET' THEN MAX(D.KCNET_TYPE)	                    ELSE ''	               END AS VENDOR_TYPE     	             , CASE WHEN A.VENDOR = 'KLNET' THEN NVL(MAX(D.KLNET_DC_RATE),0)	                    WHEN A.VENDOR = 'KTNET' THEN NVL(MAX(D.KTNET_DC_RATE),0)	                    WHEN A.VENDOR = 'KCNET' THEN NVL(MAX(D.KCNET_DC_RATE),0)	                    ELSE 0	               END AS VENDOR_DC_RATE 	             , MAX(A.M_STXID) AS M_STXID	          FROM (	                SELECT A.M_SSNDRTPCODE             AS CUST_CD	                     , A.M_SDOCNAME        	       AS DOC_CD	                     , A2.CD_NM                    AS DOC_CD2	                     , SUBSTR(A.M_SRCVRTPCODE,1,5) AS VENDOR	                     , 1                   		   AS SEND_CNT	                     , A.M_NTOSIZE                 AS SEND_SIZE	                     , A.M_STXID	                  FROM TTXSTAT@ELVIS_CHAIN A 	                       LEFT OUTER JOIN MDM_COM_CODE A2	                            ON A.M_SDOCNAME = A2.COMN_CD	                           AND A2.GRP_CD = 'Y04'					 WHERE 1=1					   AND A.M_SRCVRTPCODE IN (SELECT COMN_CD FROM MDM_COM_CODE WHERE GRP_CD ='Y03')					   AND A.M_BSENDRESULT = 'T' 					   AND A.M_STXSTATUS = 'TS'					   AND A.M_DSENDTIME >= TO_DATE('@FM_YMD','yyyyMMdd')					   AND A.M_DSENDTIME < TO_DATE('@TO_YMD','yyyyMMdd')+1					   AND A.M_SDOCNAME IN ('ARDCD', 'AIRDO', 'AIRDC', 'ARAMS', 'FWB', 'ICMOD', 'OCMOD', 'OMFCS')					   [CUST_CD]					      AND A.M_SSNDRTPCODE = '@CUST_CD'					   [/CUST_CD]					   [DOC_CD]					      AND A.M_SDOCNAME = '@DOC_CD'					   [/DOC_CD]					   [VENDOR]					      AND A.M_SRCVRTPCODE LIKE '@VENDOR%'					   [/VENDOR]	              ) A LEFT OUTER JOIN T_CUST B	                    ON A.CUST_CD = B.CUSTOMS_CD AND B.USE_YN = 'Y'	                  LEFT OUTER JOIN ECH_CUST_TARIFF C	                    ON A.CUST_CD = C.CUST_CD	                   AND A.DOC_CD = C.DOC_CD	                   AND A.VENDOR = C.VENDOR        	                  LEFT OUTER JOIN ECH_VENDOR_TARIFF D	                    ON A.DOC_CD = D.DOC_CD            WHERE 1 = 1	        [CRM_CUST_CD]	        	AND B.CUST_CD = '@CRM_CUST_CD'	        [/CRM_CUST_CD]	          			[CUST_NM]			  	AND B.CUST_LOC_NM LIKE '@CUST_NM%'			[/CUST_NM]				          GROUP BY A.CUST_CD,A.DOC_CD,A.VENDOR	      ) A	      LEFT OUTER JOIN MDM_COM_CODE B	           ON A.DOC_CD = B.COMN_CD 	          AND B.GRP_CD = 'Y01'	      LEFT OUTER JOIN TTP_EDIFACT@ELVIS_CHAIN C	         ON A.CUST_CD = C.M_STPCODE	WHERE  SUBSTR(C.M_SSRID,1,2) = 'FF'        	UNION ALL	SELECT A.CUST_CD	     , A.CUST_NM	     , '' AS CUST_ID	     , A.DOC_CD	     , A.DOC_CD2	     , B.CD_NM AS DOC_NM	     , A.VENDOR	     , A.SEND_CNT	     , A.SEND_SIZE	     , CASE WHEN A.CUST_RATE = 0 	            THEN A.VENDOR_RATE	            ELSE A.CUST_RATE	       END AS CUST_RATE     	     , CASE WHEN A.CUST_DC_RATE = 0 	            THEN A.VENDOR_DC_RATE	            ELSE A.CUST_DC_RATE	       END AS CUST_DC_RATE     	     , CASE WHEN A.CUST_RATE = 0 	            THEN ROUND(A.VENDOR_RATE * A.SEND_SIZE * 						       CASE WHEN A.CUST_DC_RATE = 0 						            THEN A.VENDOR_DC_RATE						            ELSE A.CUST_DC_RATE						        END,0)	            ELSE ROUND(A.CUST_RATE * A.SEND_SIZE * 						       CASE WHEN A.CUST_DC_RATE = 0 						            THEN A.VENDOR_DC_RATE						            ELSE A.CUST_DC_RATE						        END,0)	       END AS CUST_AMT	     , A.VENDOR_RATE	     , A.VENDOR_DC_RATE	     , CASE WHEN A.VENDOR_DC_RATE = 0 	            THEN ROUND(A.VENDOR_RATE * A.SEND_SIZE,0)	            ELSE ROUND(A.VENDOR_RATE * A.SEND_SIZE * A.VENDOR_DC_RATE,0)	       END AS VENDOR_AMT 	     , A.VENDOR_TYPE  	     , 1 AS RNUM	  FROM (	        SELECT A.CUST_CD	             , MAX(B.CUST_LOC_NM) AS CUST_NM	             , A.DOC_CD	             , MAX(A.DOC_CD2) AS DOC_CD2	             , A.VENDOR	             , SUM(A.SEND_CNT)  AS SEND_CNT	             , ROUND(NVL(SUM(A.SEND_SIZE),0)/1024,0) AS SEND_SIZE	             , NVL(MAX(C.UNIT_PRC),0)  AS CUST_RATE	             , NVL(MAX(C.DC_RATE),0)  AS CUST_DC_RATE	             , CASE WHEN A.VENDOR = 'KLNET' THEN NVL(MAX(D.KLNET),0)	                    WHEN A.VENDOR = 'KTNET' THEN NVL(MAX(D.KTNET),0)	                    WHEN A.VENDOR = 'KCNET' THEN NVL(MAX(D.KCNET),0)	                    ELSE 0	               END AS VENDOR_RATE     	             , CASE WHEN A.VENDOR = 'KLNET' THEN MAX(D.KLNET_TYPE)	                    WHEN A.VENDOR = 'KTNET' THEN MAX(D.KTNET_TYPE)	                    WHEN A.VENDOR = 'KCNET' THEN MAX(D.KCNET_TYPE)	                    ELSE ''	               END AS VENDOR_TYPE     	             , CASE WHEN A.VENDOR = 'KLNET' THEN NVL(MAX(D.KLNET_DC_RATE),0)	                    WHEN A.VENDOR = 'KTNET' THEN NVL(MAX(D.KTNET_DC_RATE),0)	                    WHEN A.VENDOR = 'KCNET' THEN NVL(MAX(D.KCNET_DC_RATE),0)	                    ELSE 0	               END AS VENDOR_DC_RATE 	          FROM (	                SELECT A.M_SSNDRTPCODE             AS CUST_CD	                     , A.M_SDOCNAME        	       AS DOC_CD	                     , A2.CD_NM                    AS DOC_CD2	                     , SUBSTR(A.M_SRCVRTPCODE,1,5) AS VENDOR	                     , 1                   		   AS SEND_CNT	                     , A.M_NTOSIZE                 AS SEND_SIZE	                  FROM TTXSTAT@ELVIS_CHAIN A 	                       LEFT OUTER JOIN MDM_COM_CODE A2	                            ON A.M_SDOCNAME = A2.COMN_CD	                           AND A2.GRP_CD = 'Y04'					 WHERE 1=1					   AND A.M_SRCVRTPCODE IN (SELECT COMN_CD FROM MDM_COM_CODE WHERE GRP_CD ='Y03')					   AND A.M_BSENDRESULT = 'T' 					   AND A.M_STXSTATUS = 'TS'					   AND A.M_DSENDTIME >= TO_DATE('@FM_YMD','yyyyMMdd')					   AND A.M_DSENDTIME < TO_DATE('@TO_YMD','yyyyMMdd')+1					   AND A.M_SDOCNAME NOT IN ('SOMFC', 'SIMFC', 'SOMOD', 'SIMOD','ARDCD', 'AIRDO', 'AIRDC', 'ARAMS', 'FWB', 'ICMOD', 'OCMOD', 'OMFCS')					   [CUST_CD]					      AND A.M_SSNDRTPCODE = '@CUST_CD'					   [/CUST_CD]					   [DOC_CD]					      AND A.M_SDOCNAME = '@DOC_CD'					   [/DOC_CD]					   [VENDOR]					      AND A.M_SRCVRTPCODE LIKE '@VENDOR%'					   [/VENDOR]	              ) A LEFT OUTER JOIN T_CUST B	                    ON A.CUST_CD = B.CUSTOMS_CD AND B.USE_YN = 'Y'	                  LEFT OUTER JOIN ECH_CUST_TARIFF C	                    ON A.CUST_CD = C.CUST_CD	                   AND A.DOC_CD = C.DOC_CD	                   AND A.VENDOR = C.VENDOR        	                  LEFT OUTER JOIN ECH_VENDOR_TARIFF D	                    ON A.DOC_CD = D.DOC_CD            WHERE 1 = 1	        [CRM_CUST_CD]	          	AND B.CUST_CD = '@CRM_CUST_CD'	        [/CRM_CUST_CD]	          			[CUST_NM]			  	AND B.CUST_LOC_NM LIKE '@CUST_NM%'			[/CUST_NM]	          GROUP BY A.CUST_CD,A.DOC_CD,A.VENDOR	      ) A	      LEFT OUTER JOIN MDM_COM_CODE B	           ON A.DOC_CD = B.COMN_CD 	          AND B.GRP_CD = 'Y01'   	UNION ALL		SELECT A.CUST_CD	     , A.CUST_NM	     , C.M_SSRID AS CUST_ID	     , A.DOC_CD	     , A.DOC_CD2	     , B.CD_NM AS DOC_NM	     , A.VENDOR	     , A.SEND_CNT	     , A.SEND_SIZE	     , CASE WHEN A.CUST_RATE = 0 	            THEN A.VENDOR_RATE	            ELSE A.CUST_RATE	       END AS CUST_RATE     	     , CASE WHEN A.CUST_DC_RATE = 0 	            THEN A.VENDOR_DC_RATE	            ELSE A.CUST_DC_RATE	       END AS CUST_DC_RATE     	     , CASE WHEN A.CUST_RATE = 0 	            THEN ROUND(A.VENDOR_RATE * A.SEND_SIZE * 						       CASE WHEN A.CUST_DC_RATE = 0 						            THEN A.VENDOR_DC_RATE						            ELSE A.CUST_DC_RATE						        END,0)	            ELSE ROUND(A.CUST_RATE * A.SEND_SIZE * 						       CASE WHEN A.CUST_DC_RATE = 0 						            THEN A.VENDOR_DC_RATE						            ELSE A.CUST_DC_RATE						        END,0)	       END AS CUST_AMT	     , A.VENDOR_RATE	     , A.VENDOR_DC_RATE	     , CASE WHEN A.VENDOR_DC_RATE = 0 	            THEN ROUND(A.VENDOR_RATE * A.SEND_SIZE,0)	            ELSE ROUND(A.VENDOR_RATE * A.SEND_SIZE * A.VENDOR_DC_RATE,0)	       END AS VENDOR_AMT 	     , A.VENDOR_TYPE  	     , 1 AS RNUM	  FROM (	        SELECT A.CUST_CD	             , MAX(B.CUST_LOC_NM) AS CUST_NM	             , A.DOC_CD	             , MAX(A.DOC_CD2) AS DOC_CD2	             , A.VENDOR	             , SUM(A.SEND_CNT)  AS SEND_CNT	             , ROUND(NVL(SUM(A.SEND_SIZE),0)/1024,0) AS SEND_SIZE	             , NVL(MAX(C.UNIT_PRC),0)  AS CUST_RATE	             , NVL(MAX(C.DC_RATE),0)  AS CUST_DC_RATE	             , CASE WHEN A.VENDOR = 'KLNET' THEN NVL(MAX(D.KLNET),0)	                    WHEN A.VENDOR = 'KTNET' THEN NVL(MAX(D.KTNET),0)	                    WHEN A.VENDOR = 'KCNET' THEN NVL(MAX(D.KCNET),0)	                    ELSE 0	               END AS VENDOR_RATE     	             , CASE WHEN A.VENDOR = 'KLNET' THEN MAX(D.KLNET_TYPE)	                    WHEN A.VENDOR = 'KTNET' THEN MAX(D.KTNET_TYPE)	                    WHEN A.VENDOR = 'KCNET' THEN MAX(D.KCNET_TYPE)	                    ELSE ''	               END AS VENDOR_TYPE     	             , CASE WHEN A.VENDOR = 'KLNET' THEN NVL(MAX(D.KLNET_DC_RATE),0)	                    WHEN A.VENDOR = 'KTNET' THEN NVL(MAX(D.KTNET_DC_RATE),0)	                    WHEN A.VENDOR = 'KCNET' THEN NVL(MAX(D.KCNET_DC_RATE),0)	                    ELSE 0	               END AS VENDOR_DC_RATE 	          FROM (	                SELECT A.M_SSNDRTPCODE             AS CUST_CD	                     , A.M_SDOCNAME        	       AS DOC_CD	                     , A2.CD_NM                    AS DOC_CD2	                     , SUBSTR(A.M_SRCVRTPCODE,1,5) AS VENDOR	                     , 1                   		   AS SEND_CNT	                     , A.M_NTOSIZE                 AS SEND_SIZE	                  FROM TTXSTAT@ELVIS_CHAIN A 	                       LEFT OUTER JOIN MDM_COM_CODE A2	                            ON A.M_SDOCNAME = A2.COMN_CD	                           AND A2.GRP_CD = 'Y04'					 WHERE 1=1                   AND A.M_STXSTATUS = 'TS'                   AND A.M_DSENDTIME >= TO_DATE('@FM_YMD','yyyyMMdd')                   AND A.M_DSENDTIME < TO_DATE('@TO_YMD','yyyyMMdd')+1                       AND A.M_SDOCNAME ='CUSAPE'                       AND A.M_SSNDRTPCODE IN ('KLNET_KCS')  	              ) A LEFT OUTER JOIN T_CUST B	                    ON A.VENDOR = B.CUSTOMS_CD AND B.USE_YN = 'Y'	                  LEFT OUTER JOIN ECH_CUST_TARIFF C	                    ON A.CUST_CD = C.CUST_CD	                   AND A.DOC_CD = C.DOC_CD	                   AND A.VENDOR = C.VENDOR        	                  LEFT OUTER JOIN ECH_VENDOR_TARIFF D	                    ON A.DOC_CD = D.DOC_CD	        WHERE 1=1	        [CUST_CD]		       	AND A.VENDOR = '@CUST_CD'			[/CUST_CD]			  	        [CRM_CUST_CD]	          	AND B.CUST_CD = '@CRM_CUST_CD'	        [/CRM_CUST_CD]	          			[CUST_NM]			  	AND B.CUST_LOC_NM LIKE '@CUST_NM%'			[/CUST_NM]	          GROUP BY A.CUST_CD,A.DOC_CD,A.VENDOR	      ) A	      LEFT OUTER JOIN MDM_COM_CODE B	           ON A.DOC_CD = B.COMN_CD 	          AND B.GRP_CD = 'Y01'	      LEFT OUTER JOIN T_KCS C	         ON A.CUST_CD = C.M_STPCODE     )	          WHERE RNUM = 1 ORDER BY CUST_CD,DOC_CD
