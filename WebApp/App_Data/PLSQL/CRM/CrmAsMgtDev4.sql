#CrmAsMgtDev4@AssignCheck
-- CrmAsMgtDev4@AssignCheckSELECT MNGT_NO  FROM CRM_AS_MST WHERE MNGT_NO = '@MNGT_NO'   AND NOT WORK_USR IS NULL
#CrmAsMgtDev4@AssignData2
--CrmAsMgtDev4@AssignData2BEGIN    --배정자료 수정    UPDATE CRM_AS_MST A       SET A.UPD_USR = '@SSN_USR_ID'         , A.UPD_YMD = TO_CHAR(SYSDATE,'yyyyMMdd')         , A.UPD_HM = TO_CHAR(SYSDATE,'HH24MISS')         , A.WORK_USR = '@USR_ID'         , A.DEPT_CD = (SELECT DEPT_CD FROM CRM_USR_MST WHERE USR_ID = '@USR_ID')          , A.PROC_TYPE = '7'         , A.REQ_SVC = (CASE WHEN '@REQ_SVC' IS NULL                             THEN (SELECT NVL(Z.OPT_ITEM2,Z.COMN_CD) FROM MDM_COM_CODE Z WHERE Z.GRP_CD = 'T02' AND Z.COMN_CD = (SELECT MAX(X.REQ_SVC) FROM CRM_AS_MST X WHERE X.MNGT_NO = '@MNGT_NO'))                             ELSE '@REQ_SVC' END)         , A.REQ_SVC2 = (CASE WHEN '@REQ_SVC2' IS NULL                               THEN (SELECT NVL(Z.OPT_ITEM2,Z.COMN_CD) FROM MDM_COM_CODE Z WHERE Z.GRP_CD = 'T05' AND Z.COMN_CD = (SELECT MAX(X.REQ_TYPE) FROM CRM_AS_MST X WHERE X.MNGT_NO = '@MNGT_NO'))                              ELSE '@REQ_SVC2' END)         , A.REQ_TYPE2 = '@REQ_SVC3'         , A.PRAR_YMD = '@PRAR_YMD'         , A.REQ_YMD = '@REQ_YMD'         , A.REQ_HM = '@REQ_HM'         , A.CMPT_YMD = '@CMPT_YMD'         , A.CMPT_HM = '@CMPT_HM'         , A.RANK = '@RANK'         , A.RMK = '@RMK'         , A.DEV_RMK = '@DEV_RMK'	 WHERE A.MNGT_NO = '@MNGT_NO';    --원본자료 수정	UPDATE CRM_AS_MST A	   SET A.PROC_TYPE = '7'	     , A.RMK = '@RMK'	 WHERE A.MNGT_NO IN (SELECT Z.ORGN_MNGT_NO FROM CRM_AS_MST Z WHERE Z.MNGT_NO = '@MNGT_NO');	     END ; 
#CrmAsMgtDev4@CrmUserInfo
--CrmAsMgtDev4@CrmUserInfo SELECT DEPT_CD,  LOC_NM , USR_ID,SORT      , (CASE WHEN RMK LIKE '%/#처리자%' THEN 'Y' ELSE 'N' END) AS WORK_USR2_YN   FROM CRM_USR_MST  WHERE USE_YN = 'Y'  
#CrmAsMgtDev4@ExceptCancel
-- CrmAsMgtDev4@ExceptCancelUPDATE CRM_AS_MST   SET EXCEPT_YN = 'N' WHERE MNGT_NO = '@MNGT_NO'
#CrmAsMgtDev4@ExceptList
-- CrmAsMgtDev4@ExceptListUPDATE CRM_AS_MST   SET EXCEPT_YN = 'Y' WHERE MNGT_NO = '@MNGT_NO'
#CrmAsMgtDev4@GetReqSvc2List
-- CrmAsMgtDev4@GetReqSvc2ListSELECT   COMN_CD AS CODE        ,  CD_NM AS NAME        , OPT_ITEM1 AS GRP_CD        , SORT  FROM MDM_COM_CODE WHERE GRP_CD = 'Z02'
#CrmAsMgtDev4@Search
-- CrmAsMgtDev4@SearchWITH W_CRM_AS_MSTAS(    SELECT A.MNGT_NO         , A.REQ_YMD         , A.REQ_HM         , A.REQ_SVC         , A.CUST_CD         , A.CONTENT         , A.REQ_USR          , A.TEL_NO         , A.PROC_TYPE         , A.WORK_USR         , A.PRAR_YMD         , A.CMPT_YMD         , A.RMK         , A.INS_USR         , A.INS_YMD         , A.PRIORITY         , A.SYS_ID         , A.REQ_TYPE2 AS REQ_SVC3         , A.REQ_SVC2         , A.DEV_CMPT_YMD         , A.SHARE_YN         , A.EXCEPT_YN         , A.DEV_ERR_YN         , A.DEV_ERR_NM         , A.ORGN_MNGT_NO         , A.RANK         , A.UPPER_MNGT_NO         , (SELECT Z.SUBJECT FROM CRM_AS_CUST Z WHERE Z.MNGT_NO = A.MNGT_NO AND ROWNUM = 1) AS SUBJECT         , TO_DATE(TO_CHAR(SYSDATE,'yyyyMMdd')) AS CHK_TODAY         , (CASE WHEN A.PRAR_YMD IS NULL THEN TO_DATE(A.REQ_YMD)+6 ELSE TO_DATE(A.PRAR_YMD) END) AS CHK_PRAR_YMD      FROM CRM_AS_MST A       WHERE A.DEPT_CD = '@DEPT_CD'     [FM_YMD]       AND A.REQ_YMD >= '@FM_YMD'     [/FM_YMD]     [TO_YMD]       AND A.REQ_YMD <= '@TO_YMD'     [/TO_YMD]     [EXCEPT_LIST]       AND A.EXCEPT_YN = 'N'     [/EXCEPT_LIST]     [ASSIGN]       AND NOT A.WORK_USR IS NULL       AND NOT A.ORGN_MNGT_NO IS NULL     [/ASSIGN]     [NON_ASSIGN]       AND A.WORK_USR IS NULL       AND NOT A.PROC_TYPE IN ('1','2','8')       AND NOT A.ORGN_MNGT_NO IS NULL     [/NON_ASSIGN]     [MNGT_NO]        AND A.MNGT_NO = '@MNGT_NO'     [/MNGT_NO]     [WORK_AREA]        AND EXISTS (SELECT '' FROM CRM_USR_MST Z WHERE Z.USR_ID = A.WORK_USR AND Z.WORK_AREA = '@WORK_AREA')     [/WORK_AREA]     [PROC_TYPE]        AND A.PROC_TYPE IN ('@PROC_TYPE')     [/PROC_TYPE]     [SEARCH_KEY]        AND ( 1 != 1              OR A.CUST_CD LIKE '%@SEARCH_KEY%'              OR B.CUST_NM LIKE '%@SEARCH_KEY%'              OR B.CUST_LOC_NM LIKE '%@SEARCH_KEY%'              OR B.DOMAIN LIKE '%@SEARCH_KEY%' 	              OR A.TEL_NO LIKE '%@SEARCH_KEY%'              OR B.CUSTOMS_CD LIKE '%@SEARCH_KEY%'              OR A.REQ_USR LIKE '%@SEARCH_KEY%'              OR A.WORK_USR LIKE '%@SEARCH_KEY%'              OR A.MNGT_NO LIKE '%@SEARCH_KEY%'              OR A.CONTENT LIKE '%@SEARCH_KEY%'            )     [/SEARCH_KEY]     [WORK_USR]        AND A.WORK_USR = '@WORK_USR'     [/WORK_USR])SELECT UFN_FORMAT(A.REQ_YMD,'DATE') AS REQ_YMD     , UFN_FORMAT(A.REQ_HM,'TIME')  AS REQ_HM     , (CASE WHEN A.SUBJECT IS NULL THEN A.CONTENT             ELSE '제목:'||TRIM(A.SUBJECT)||CHR(13)||CHR(10)||'내용:'||A.CONTENT        END) AS CONTENT2     , UFN_FORMAT(A.INS_YMD,'DATE') AS INS_YMD     , B.CUST_LOC_NM AS CUST_NM     , B.DEV_PIC     , (CASE WHEN A.SYS_ID IN ('CRM','MAIL') THEN (SELECT Z.LOC_NM FROM CRM_USR_MST Z WHERE Z.INS_USR = A.INS_USR AND ROWNUM = 1)             ELSE A.SYS_ID        END) AS INS_USR_NM     , (CASE WHEN A.SYS_ID IN ('CRM','MAIL') THEN 'CRM' ELSE '고객' END) AS SYS_NM     , (SELECT WM_CONCAT(DISTINCT (SELECT X.CD_NM FROM MDM_COM_CODE X WHERE X.GRP_CD = 'C01' AND X.COMN_CD = Z.SVC_CD)) FROM CRM_CUST_SVC Z WHERE Z.CUST_CD = A.CUST_CD AND Z.SVC_CD IS NOT NULL) AS SVC_NM     , (CASE A.RANK WHEN 'A' THEN '상'WHEN 'B' THEN '중' WHEN 'C' THEN '하' ELSE '' END) AS RANK     , (CASE WHEN (SELECT COUNT(X.MNGT_NO) FROM COM_DOC_MST X WHERE X.MNGT_NO = A.MNGT_NO) >= 1 THEN 'Y' ELSE 'N' END) AS FILE_YN     , (CASE WHEN (A.CHK_TODAY - A.CHK_PRAR_YMD) < 0 THEN 0 ELSE A.CHK_TODAY - A.CHK_PRAR_YMD END) AS DELAY     , (CASE WHEN (A.CHK_TODAY - A.CHK_PRAR_YMD) > 0 THEN 'Y' ELSE 'N' END) DELAY_YN     , A.*  FROM W_CRM_AS_MST A       INNER JOIN CRM_CUST_MST B               ON A.CUST_CD = B.CUST_CD ORDER BY A.REQ_YMD||A.REQ_HM DESC 
#CrmAsMgtDev4@Search2
--CrmAsMgtDev4@Search2WITH W_CRM_CUST_SVCAS(    SELECT A.CUST_CD         , SUBSTR(            XMLAGG(                XMLELEMENT(COL ,',', B.CD_NM) ORDER BY B.CD_NM).EXTRACT('//text()'            ).GETSTRINGVAL()           , 2) AS SVC_CD         , SUBSTR(            XMLAGG(                XMLELEMENT(COL ,',', C.CD_NM) ORDER BY B.CD_NM).EXTRACT('//text()'            ).GETSTRINGVAL()           , 2) AS DEPT_CD         , SUBSTR(            XMLAGG(                XMLELEMENT(COL ,',', A.SALES_NM) ORDER BY B.CD_NM).EXTRACT('//text()'            ).GETSTRINGVAL()           , 2) AS SALES_NM      FROM CRM_CUST_SVC A           INNER JOIN MDM_COM_CODE B                   ON A.SVC_CD = B.COMN_CD                  AND B.GRP_CD = 'C01'           INNER JOIN MDM_COM_CODE C                   ON A.DEPT_CD = C.COMN_CD                  AND C.GRP_CD = 'C03'     WHERE A.SVC_CD IS NOT NULL     GROUP BY A.CUST_CD )SELECT A.*      , CASE WHEN A.CHK_TODAY - A.CHK_PRAR_YMD < 0             THEN 0             ELSE A.CHK_TODAY - A.CHK_PRAR_YMD         END AS DELAY     , CASE WHEN A.CHK_TODAY - A.CHK_PRAR_YMD > 0             THEN 'Y'            ELSE 'N'        END DELAY_YN  FROM (	SELECT A.MNGT_NO	     , W.SEQ	     , A.REQ_YMD	     , A.REQ_HM 	     , A.CUST_CD 	     , B.CUST_LOC_NM AS CUST_NM 	     , A.CONTENT	     , A.REQ_USR	     , A.TEL_NO 	     , A.REQ_TYPE	     , A.PRIORITY 	     , A.RMK||CHR(13)||CHR(10)||W.DEV_CONTENT AS RMK	     , A.CMPT_RMK	     , CASE WHEN A.MNGT_NO = '@S_MNGT_NO' THEN 'A' ELSE 'B' END SORT_NO	     , C.LOC_NM AS INS_USR	     , B.USE_YN	     , D.SVC_CD	     , B.MATN_YN	     , D.SALES_NM	     , A.FREE_YN	     , CASE WHEN (SELECT COUNT(X.MNGT_NO)                        FROM COM_DOC_MST X                       WHERE X.MNGT_NO = A.MNGT_NO) >= 1                THEN 'Y'                ELSE 'N'           END AS FILE_YN         , A.SYS_ID         , NVL(A.DEPT_CD,'01') AS DEPT_CD         , (SELECT CD_NM              FROM MDM_COM_CODE X             WHERE GRP_CD = 'C03'               AND X.COMN_CD = NVL(A.DEPT_CD,'01')) AS DEPT_NM            , (SELECT LOC_NM FROM CRM_USR_MST  X WHERE X.USR_ID =W.USR_ID) AS WORK_USR_NM           , W.USR_ID AS WORK_ID 	      , W.PRAR_YMD	      , W.CMPT_YMD	      , W.DEV_CONTENT	      , NVL(W.PROC_TYPE,'1') AS PROC_TYPE	      , W.USR_ID          , CASE WHEN W.PRAR_YMD IS NULL                  THEN TO_DATE(A.REQ_YMD)+6                 ELSE TO_DATE(W.PRAR_YMD)             END AS CHK_PRAR_YMD    	               , TO_DATE(TO_CHAR(SYSDATE,'yyyyMMdd')) AS CHK_TODAY            , W.REQ_SVC3          , UFN_FORMAT(A.INS_YMD,'DATE') AS INS_YMD	  FROM CRM_AS_MST_WORK W	     , CRM_AS_MST A	       INNER JOIN CRM_CUST_MST B                   ON A.CUST_CD = B.CUST_CD	       LEFT OUTER JOIN CRM_USR_MST C	               ON A.INS_USR = C.USR_ID           LEFT OUTER JOIN W_CRM_CUST_SVC D                   ON A.CUST_CD = D.CUST_CD           LEFT OUTER JOIN CRM_AS_CUST E                   ON A.MNGT_NO = E.MNGT_NO           LEFT OUTER JOIN CRM_AS_MST_WORK T                   ON A.MNGT_NO = T.MNGT_NO                   AND T.SEQ = 1	 WHERE 1 = 1	   AND W.MNGT_NO = A.MNGT_NO	   AND W.SEQ <> 0	   [FM_YMD]	       AND A.REQ_YMD >= '@FM_YMD'	   [/FM_YMD]	   [TO_YMD]	       AND A.REQ_YMD <= '@TO_YMD'	   [/TO_YMD]	   [S_PROC_TYPE]	       AND W.PROC_TYPE IN ('@S_PROC_TYPE')	   [/S_PROC_TYPE]	   [S_SVC_CD]	       AND B.CUST_CD IN (SELECT CUST_CD FROM CRM_CUST_SVC WHERE SVC_CD IN ('@S_SVC_CD'))	   [/S_SVC_CD]	   [SEARCH_KEY]		   AND ( 1 != 1			   OR A.CUST_CD LIKE '%@SEARCH_KEY%'			   OR B.CUST_NM LIKE '%@SEARCH_KEY%'			   OR B.CUST_LOC_NM LIKE '%@SEARCH_KEY%'			   OR B.DOMAIN LIKE '%@SEARCH_KEY%' 				   OR A.TEL_NO LIKE '%@SEARCH_KEY%'			   OR B.CUSTOMS_CD LIKE '%@SEARCH_KEY%'			   OR A.REQ_USR LIKE '%@SEARCH_KEY%'			   OR A.WORK_USR LIKE '%@SEARCH_KEY%'			   OR A.MNGT_NO LIKE '%@SEARCH_KEY%'			   OR A.CONTENT LIKE '%@SEARCH_KEY%'	       )	   [/SEARCH_KEY]	   [WORK_USR]		   AND T.USR_ID = '@WORK_USR'	   [/WORK_USR]	   [DEPT_CD]	       AND T.DEPT_CD = '@DEPT_CD'	   [/DEPT_CD]  ) A ORDER BY A.SORT_NO  [PRIORITY]    , A.PRIORITY  [/PRIORITY]  ,A.REQ_YMD||A.REQ_HM DESC
#CrmAsMgtDev4@SearchAssign_20190317
--CrmAsMgtDev4@SearchAssignWITH W_CRM_CUST_SVCAS(    SELECT A.CUST_CD         , SUBSTR(            XMLAGG(                XMLELEMENT(COL ,',', B.CD_NM) ORDER BY B.CD_NM).EXTRACT('//text()'            ).GETSTRINGVAL()           , 2) AS SVC_CD         , SUBSTR(            XMLAGG(                XMLELEMENT(COL ,',', C.CD_NM) ORDER BY B.CD_NM).EXTRACT('//text()'            ).GETSTRINGVAL()           , 2) AS DEPT_CD         , SUBSTR(            XMLAGG(                XMLELEMENT(COL ,',', A.SALES_NM) ORDER BY B.CD_NM).EXTRACT('//text()'            ).GETSTRINGVAL()           , 2) AS SALES_NM      FROM CRM_CUST_SVC A           INNER JOIN MDM_COM_CODE B                   ON A.SVC_CD = B.COMN_CD                  AND B.GRP_CD = 'C01'           INNER JOIN MDM_COM_CODE C                   ON A.DEPT_CD = C.COMN_CD                  AND C.GRP_CD = 'C03'     WHERE A.SVC_CD IS NOT NULL     GROUP BY A.CUST_CD )SELECT A.*      , CASE WHEN A.CHK_TODAY - A.CHK_PRAR_YMD < 0             THEN 0             ELSE A.CHK_TODAY - A.CHK_PRAR_YMD         END AS DELAY     , CASE WHEN A.CHK_TODAY - A.CHK_PRAR_YMD > 0             THEN 'Y'            ELSE 'N'        END DELAY_YN  FROM (	SELECT A.MNGT_NO	     , W.SEQ	     , A.REQ_YMD	     , A.REQ_HM 	     , A.CUST_CD 	     , B.CUST_LOC_NM AS CUST_NM 	     , A.CONTENT	     , A.REQ_USR	     , A.TEL_NO 	     , A.REQ_TYPE	     , A.PRIORITY 	     , A.RMK||CHR(13)||CHR(10)||W.DEV_CONTENT AS RMK	     , A.CMPT_RMK	     , CASE WHEN A.MNGT_NO = '@S_MNGT_NO' THEN 'A' ELSE 'B' END SORT_NO         , CASE WHEN A.SYS_ID = 'CRM'                THEN  C.LOC_NM                ELSE (SELECT MAX(Y.LOC_NM)                      FROM CRM_AS_MST_WORK X                         , CRM_USR_MST Y                     WHERE X.MNGT_NO = A.MNGT_NO                       AND X.USR_ID = Y.USR_ID                       AND X.SEQ = 0)            END AS INS_USR_NM	     , B.USE_YN	     , D.SVC_CD	     , B.MATN_YN	     , D.SALES_NM	     , A.FREE_YN	     , CASE WHEN (SELECT COUNT(X.MNGT_NO)                        FROM COM_DOC_MST X                       WHERE X.MNGT_NO = A.MNGT_NO) >= 1                THEN 'Y'                ELSE 'N'           END AS FILE_YN         , A.SYS_ID         , NVL(A.DEPT_CD,'01') AS DEPT_CD         , (SELECT CD_NM              FROM MDM_COM_CODE X             WHERE GRP_CD = 'C03'               AND X.COMN_CD = NVL(A.DEPT_CD,'01')) AS DEPT_NM            , (SELECT LOC_NM FROM CRM_USR_MST  X WHERE X.USR_ID =W.USR_ID) AS WORK_USR_NM           , W.USR_ID AS WORK_ID 	      , W.PRAR_YMD	      , W.CMPT_YMD	      , W.DEV_CONTENT	      , NVL(W.PROC_TYPE,'1') AS PROC_TYPE	      , W.USR_ID          , CASE WHEN W.PRAR_YMD IS NULL                  THEN TO_DATE(A.REQ_YMD)+6                 ELSE TO_DATE(W.PRAR_YMD)             END AS CHK_PRAR_YMD    	               , TO_DATE(TO_CHAR(SYSDATE,'yyyyMMdd')) AS CHK_TODAY            , W.REQ_SVC          , W.REQ_SVC2          , W.REQ_SVC3          , UFN_FORMAT(A.INS_YMD,'DATE') AS INS_YMD          , CASE WHEN W.RANK = 'A' THEN '상'                 WHEN W.RANK = 'B' THEN '중'                 WHEN W.RANK = 'C' THEN '하'                 ELSE ''             END AS RANK         , W.RMK AS DEV_RMK            , A.SHARE_YN         , A.DEV_ERR_YN         , A.DEV_ERR_NM	  FROM CRM_AS_MST_WORK W           LEFT OUTER JOIN CRM_USR_MST W2                   ON W.USR_ID = W2.USR_ID	     , CRM_AS_MST A	       INNER JOIN CRM_CUST_MST B                   ON A.CUST_CD = B.CUST_CD	       LEFT OUTER JOIN CRM_USR_MST C	               ON A.INS_USR = C.USR_ID           LEFT OUTER JOIN W_CRM_CUST_SVC D                   ON A.CUST_CD = D.CUST_CD           LEFT OUTER JOIN CRM_AS_CUST E                   ON A.MNGT_NO = E.MNGT_NO           LEFT OUTER JOIN CRM_AS_MST_WORK T                   ON A.MNGT_NO = T.MNGT_NO                   AND T.SEQ = 1	 WHERE 1 = 1	   AND W.MNGT_NO = A.MNGT_NO	   AND W.SEQ <> 0	   AND W.DEPT_CD = '@DEPT_CD'	   [WORK_AREA]	       AND W2.WORK_AREA = '@WORK_AREA'	   [/WORK_AREA]	   [FM_YMD]	       AND A.REQ_YMD >= '@FM_YMD'	   [/FM_YMD]	   [TO_YMD]	       AND A.REQ_YMD <= '@TO_YMD'	   [/TO_YMD]	   [S_PROC_TYPE]	       AND W.PROC_TYPE IN ('@S_PROC_TYPE')	   [/S_PROC_TYPE]	   [S_SVC_CD]	       AND B.CUST_CD IN (SELECT CUST_CD FROM CRM_CUST_SVC WHERE SVC_CD IN ('@S_SVC_CD'))	   [/S_SVC_CD]	   [SEARCH_KEY]		   AND ( 1 != 1			   OR A.CUST_CD LIKE '%@SEARCH_KEY%'			   OR B.CUST_NM LIKE '%@SEARCH_KEY%'			   OR B.CUST_LOC_NM LIKE '%@SEARCH_KEY%'			   OR B.DOMAIN LIKE '%@SEARCH_KEY%' 				   OR A.TEL_NO LIKE '%@SEARCH_KEY%'			   OR B.CUSTOMS_CD LIKE '%@SEARCH_KEY%'			   OR A.REQ_USR LIKE '%@SEARCH_KEY%'			   OR A.WORK_USR LIKE '%@SEARCH_KEY%'			   OR A.MNGT_NO LIKE '%@SEARCH_KEY%'			   OR A.CONTENT LIKE '%@SEARCH_KEY%'	       )	   [/SEARCH_KEY]	   [WORK_USR]		   AND T.USR_ID = '@WORK_USR'	   [/WORK_USR]	   [DEPT_CD]	       AND T.DEPT_CD = '@DEPT_CD'	   [/DEPT_CD]  ) A ORDER BY A.SORT_NO  [PRIORITY]    , A.PRIORITY  [/PRIORITY]  ,A.REQ_YMD||A.REQ_HM DESC
#CrmAsMgtDev4@SearchInput
--CrmAsMgtDev4@SearchInput SELECT A.*     , TO_CLOB(A.CUST_CONT)||CHR(13)||CHR(10)||CHR(13)||CHR(10)||'<조치결과>---------------------------------------------'||CHR(13)||CHR(10)||CHR(13)||CHR(10)||A.CALL_CONT||CHR(13)||CHR(10)||CHR(13)||CHR(10)||A.DEV_CONT AS CONTENT  FROM (		SELECT UFN_FORMAT(A.REQ_YMD,'DATE')  || ' ' || UFN_FORMAT(A.REQ_HM,'TIME')    AS  AS_REQ_YMD		     , A.MNGT_NO   AS MNGT_NO 		     , A.REQ_USR		     , A.TEL_NO  		     , B.CUST_LOC_NM AS CUST_NM 		     , A.CUST_CD   		     , B.CUST_NM AS CUST_ENG_NM             , A.CONTENT AS CUST_CONT             , A.RMK     AS CALL_CONT             , CASE WHEN TRIM(A.CONTENT)= TRIM(A.CONTENT)                    THEN ''                    ELSE W.CONTENT                END AS DEV_CONT 		     , (SELECT CD_NM				  FROM MDM_COM_CODE X				 WHERE X.GRP_CD = 'T05' 				   AND X.COMN_CD = A.REQ_TYPE) AS REQ_TYPE 		     , (SELECT CD_NM				  FROM MDM_COM_CODE X				 WHERE X.GRP_CD = 'T01' 				   AND X.COMN_CD = A.PRIORITY)  AS PRIORITY  		     , A.CMPT_RMK AS AS_CMPT_RMK   		     , NVL( A.DEPT_CD, '01') AS DEPT_CD		     , A.INS_USR	              , CASE WHEN A.SYS_ID = 'CRM'                     THEN (SELECT MAX(X.LOC_NM)                            FROM CRM_USR_MST X                           WHERE X.USR_ID = A.INS_USR)                    ELSE (SELECT MAX(Y.LOC_NM)                            FROM CRM_AS_MST_WORK X, CRM_USR_MST Y                           WHERE X.MNGT_NO = A.MNGT_NO                             AND X.USR_ID = Y.USR_ID                             AND X.SEQ = 0)                                   END AS INS_USR_NM  		     , NVL( NVL( ( SELECT REPLACE( WM_CONCAT( DEPT_CD) ,',','; ')                       FROM CRM_AS_MST_SHARE X                      WHERE X.MNGT_NO = A.MNGT_NO) ,A.DEPT_CD ) , '01') AS DEPT_AUTH_LIST             , NVL(A.DEV_PROC_TYPE,'1') AS DEV_PROC_TYPE             , A.DEV_PRAR_YMD              , A.DEV_CMPT_YMD             , A.DEV_PRIORITY 			 , A.DEV_TEST_CHK_YMD 			 , A.DEV_TEST_CMPT_YMD   			 , A.AS_TEST_CHK_YMD  			 , NVL(W.PROC_TYPE,'1') AS PROC_TYPE			 , (SELECT LOC_NM FROM CRM_USR_MST  X WHERE X.USR_ID =W.WORK_USR) AS WORK_USR_NM 			 , W.PRAR_YMD			 , W.REQ_YMD			 , W.REQ_HM			 , W.CMPT_YMD			 , W.CMPT_HM			 , W.TEST_REQ_YMD 			 , NVL(W.TEST_RESULT,'1') AS TEST_RESULT			 , W.TEST_CMPT_YMD			 , W.DEV_CONTENT 			 , W.TEST_USR_ID			 , W.WORK_USR	         , W.REQ_SVC	         , W.REQ_SVC2	         , W.REQ_TYPE2 AS REQ_SVC3	         , W.REQ_SVC2 AS T_REQ_SVC2	         , A.RMK	         , A.CMPT_RMK	         , UFN_FORMAT(A.INS_YMD,'DATE') AS INS_YMD			 , (SELECT MAX(CASE RANK				             WHEN 'A' THEN '사장'				             WHEN 'B' THEN '전무'				             WHEN 'C' THEN '상무'				             WHEN 'D' THEN '이사'				             WHEN 'E' THEN '부장'				             WHEN 'F' THEN '차장'				             WHEN 'G' THEN '과장'				             WHEN 'H' THEN '대리'				             WHEN 'I' THEN '계장'				             WHEN 'J' THEN '주임'				             WHEN 'K' THEN '사원'				             WHEN 'L' THEN '책임'				             WHEN 'M' THEN '선임'				             ELSE RANK				        END)			      FROM CRM_CUST_PIC 			   WHERE CUST_CD = A.CUST_CD AND PIC_NM = A.REQ_USR) AS RANK_NM      	         			 , A.SAVE_CNT			 , W.RANK			 , W.RMK AS DEV_RMK			 , A.SHARE_YN			 , A.DEV_ERR_YN			 , A.DEV_ERR_NM          FROM CRM_AS_MST W               INNER JOIN CRM_AS_MST A                       ON W.ORGN_MNGT_NO = A.MNGT_NO               INNER JOIN CRM_CUST_MST B                       ON A.CUST_CD = B.CUST_CD		 WHERE W.MNGT_NO = '@MNGT_NO'  		   AND W.WORK_USR = '@WORK_USR'   ) A
#CrmAsMgtDev4@SearchReq_20190317
-- CrmAsMgtDev4@SearchReqWITH W_CRM_CUST_SVCAS(    SELECT A.CUST_CD         , SUBSTR(            XMLAGG(                XMLELEMENT(COL ,',', B.CD_NM) ORDER BY B.CD_NM).EXTRACT('//text()'            ).GETSTRINGVAL()           , 2) AS SVC_CD         , SUBSTR(            XMLAGG(                XMLELEMENT(COL ,',', C.CD_NM) ORDER BY B.CD_NM).EXTRACT('//text()'            ).GETSTRINGVAL()           , 2) AS DEPT_CD         , SUBSTR(            XMLAGG(                XMLELEMENT(COL ,',', A.SALES_NM) ORDER BY B.CD_NM).EXTRACT('//text()'            ).GETSTRINGVAL()           , 2) AS SALES_NM      FROM CRM_CUST_SVC A           INNER JOIN MDM_COM_CODE B                   ON A.SVC_CD = B.COMN_CD                  AND B.GRP_CD = 'C01'           INNER JOIN MDM_COM_CODE C                   ON A.DEPT_CD = C.COMN_CD                  AND C.GRP_CD = 'C03'     WHERE A.SVC_CD IS NOT NULL     GROUP BY A.CUST_CD )SELECT DISTINCT A.*               , CASE WHEN A.RMK IS NULL                      THEN A.CONTENT2                     ELSE A.CONTENT2||CHR(13)||CHR(10)||'※ 고객지원팀 요청 ※'||CHR(13)||CHR(10)||A.RMK                END AS CONTENT       FROM (	SELECT A.MNGT_NO         , A.CUST_CD         , B.CUST_LOC_NM AS CUST_NM         , UFN_FORMAT(A.REQ_YMD,'DATE') AS REQ_YMD         , UFN_FORMAT(A.REQ_HM,'TIME')  AS REQ_HM         , A.REQ_YMD||A.REQ_HM AS SORT         , A.REQ_USR          , A.TEL_NO         , (CASE WHEN E.SUBJECT IS NULL THEN A.CONTENT                 ELSE '제목:'||TRIM(E.SUBJECT)||CHR(13)||CHR(10)||'내용:'||A.CONTENT            END) AS CONTENT2         , A.RMK         , CASE WHEN A.ASSIGN_YN = 'N' THEN '0' ELSE A.PROC_TYPE END AS PROC_TYPE          , A.INS_USR          , CASE WHEN A.SYS_ID = 'CRM'                THEN C.LOC_NM                ELSE (SELECT MAX(Y.LOC_NM)                      FROM CRM_AS_MST_WORK X                         , CRM_USR_MST Y                     WHERE X.MNGT_NO = A.MNGT_NO                       AND X.USR_ID = Y.USR_ID                       AND X.SEQ = 0)            END AS INS_USR_NM         , A.REQ_SVC         , A.PRIORITY         , A.SYS_ID  	     , CASE WHEN A.SYS_ID = 'ELVIS' THEN '고객' ELSE 'CRM' END AS SYS_NM         , UFN_FORMAT(A.INS_YMD,'DATE') AS INS_YMD          , D.SVC_CD         , A.EXCEPT_YN		 , (SELECT MAX(CASE RANK		                WHEN 'A' THEN '사장'			             WHEN 'B' THEN '전무'			             WHEN 'C' THEN '상무'			             WHEN 'D' THEN '이사'			             WHEN 'E' THEN '부장'			             WHEN 'F' THEN '차장'			             WHEN 'G' THEN '과장'			             WHEN 'H' THEN '대리'			             WHEN 'I' THEN '계장'			             WHEN 'J' THEN '주임'			             WHEN 'K' THEN '사원'			             WHEN 'L' THEN '책임'			             WHEN 'M' THEN '선임'			             ELSE RANK			        END)		      FROM CRM_CUST_PIC 		   WHERE CUST_CD = A.CUST_CD AND PIC_NM = A.REQ_USR) AS RANK_NM      		 , B.DEV_PIC  	  FROM CRM_AS_MST A  	       INNER JOIN CRM_CUST_MST B                   ON A.CUST_CD = B.CUST_CD	       LEFT OUTER JOIN CRM_USR_MST C	               ON A.INS_USR = C.USR_ID           LEFT OUTER JOIN CRM_AS_CUST E                   ON A.MNGT_NO = E.MNGT_NO           LEFT OUTER JOIN CRM_AS_MST_SHARE F                  ON A.MNGT_NO = F.MNGT_NO            LEFT OUTER JOIN W_CRM_CUST_SVC D                   ON A.CUST_CD = D.CUST_CD	 WHERE 1 = 1       AND (A.REQ_YMD >= '@FM_YMD' AND A.REQ_YMD <= '@TO_YMD'  OR A.MNGT_NO IN ('YJITS2018100657','20180831101135077311','20180829145647898576','20180829140841817912','YJITS2018073814','YJITS2018073205','YJITS2018060872'))       [EXCEPT_LIST]           AND A.EXCEPT_YN = 'N'       [/EXCEPT_LIST]       AND NOT A.PROC_TYPE IN ('1','2','8')       AND (F.DEPT_CD = '@DEPT_CD' AND F.EXCEPT_YN = 'N')       AND NOT EXISTS (SELECT X.MNGT_NO FROM CRM_AS_MST_WORK X WHERE X.MNGT_NO = A.MNGT_NO AND X.SEQ = 1)    ) A ORDER BY A.SORT DESC 
#CrmAsMgtDev4@Update2
--CrmAsMgtDev4@Update2BEGIN 	--원본자료	  UPDATE CRM_AS_MST	     SET RMK = '@RMK'	       , SAVE_CNT  = SAVE_CNT + 1	       , DEV_CMPT_YMD = '@CMPT_YMD'	       , CMPT_RMK  = '@CMPT_RMK'	       --, PROC_TYPE = '7' --재저장시 처리중으로 변경됨	       , DEV_ERR_YN   ='@DEV_ERR_YN'	       , DEV_ERR_NM ='@DEV_ERR_NM'	       , SHARE_YN ='@SHARE_YN'	   WHERE MNGT_NO   = '@MNGT_NO'	  ;	--개발팀	 UPDATE CRM_AS_MST	     SET PRAR_YMD  = '@PRAR_YMD'  		--예정일자 	       [REQ_YMD], REQ_YMD  = '@REQ_YMD'[/REQ_YMD]	       [REQ_HM], REQ_HM = '@REQ_HM'[/REQ_HM]	       , CMPT_YMD  = '@CMPT_YMD'		--완료일자 	       , CMPT_HM = '@CMPT_HM'	       , PROC_TYPE = '@PROC_TYPE' 	       , REQ_SVC   ='@REQ_SVC'	       , REQ_SVC2  ='@REQ_SVC2'	       , REQ_TYPE2  ='@REQ_SVC3'	       , RMK       ='@DEV_RMK'	       , RANK      ='@RANK'	   WHERE ORGN_MNGT_NO   = '@MNGT_NO'	  ;	  --처리중, 개발팀 공유완료, 공유자료 미생성시에만 온라인접수 건으로 업데이트      UPDATE CRM_AS_MST	A         SET A.ONLINE_YN = 'Y'           , A.PROC_TYPE = '7'       WHERE A.ORGN_MNGT_NO   = '@MNGT_NO'         AND A.PROC_TYPE IN ('7','1') --처리중 / 개발팀에서 완료 -> 공유완료 변경하는 경우 있음         AND '9' = '@PROC_TYPE' --개발팀 공유완료      ;               --개발팀 완료시 메인자료도 완료처리      UPDATE CRM_AS_MST	A         SET A.PROC_TYPE = '1'            , A.ONLINE_YN = (CASE WHEN A.ONLINE_YN = 'Y' THEN 'A' ELSE A.ONLINE_YN END)       WHERE A.ORGN_MNGT_NO   = '@MNGT_NO'         AND A.PROC_TYPE IN ('7','1') --처리중         AND '1' = '@PROC_TYPE' --개발팀 완료      ; END;
#CrmAsMgtDev4@UpdateMergeWorkUsr2_20190402
--CrmAsMgtDev4@UpdateMergeWorkUsr2BEGIN     MERGE INTO CRM_AS_MST_WORK W        USING ( SELECT '@MNGT_NO' AS MNGT_NO                     , '@USR_ID' AS USR_ID                      , 1 AS SEQ                     , ( SELECT DEPT_CD                           FROM CRM_USR_MST                          WHERE USR_ID = '@USR_ID') AS DEPT_CD                     , '@SSN_USR_ID' AS SSN_USR_ID                     , TO_CHAR(SYSDATE,'yyyyMMdd') AS USR_YMD                     , TO_CHAR(SYSDATE,'HH24MISS') AS USR_HM                 FROM DUAL )  A     ON ( W.MNGT_NO = A.MNGT_NO AND W.SEQ = A.SEQ )   WHEN MATCHED THEN        UPDATE SET W.USR_ID = A.USR_ID, W.DEPT_CD = A.DEPT_CD                   , W.UPD_USR = A.SSN_USR_ID, W.UPD_YMD = A.USR_YMD, W.UPD_HM = A.USR_HM   WHEN NOT MATCHED THEN	    INSERT (W.MNGT_NO ,W.SEQ, W.USR_ID, W.DEPT_CD, INS_USR, INS_YMD, INS_HM, UPD_USR, UPD_YMD, UPD_HM)	    VALUES (A.MNGT_NO ,A.SEQ, A.USR_ID, A.DEPT_CD, A.SSN_USR_ID, A.USR_YMD, A.USR_HM, A.SSN_USR_ID, A.USR_YMD, A.USR_HM);       END ;
