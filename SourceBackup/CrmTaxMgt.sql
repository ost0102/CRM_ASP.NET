#CrmTaxMgt@SearchCompare
--CrmTaxMgt@SearchCompare--상태  SELECT  A.TAXNO         ,A.CUST         ,A.CUSTNM AS NAME2         ,UFN_FORMAT(TRIM(MAX (A.REGNO)),'CRN') AS REGNO         ,MAX (A.ADDR) AS ADDR         ,A.CUSTNM          ,UFN_FORMAT(MAX (C.CTRT_STRT_YMD),'DATE') AS CTRT_STRT_YMD         ,MAX (D.DEPTNM) AS DEPTNM         ,MAX (E.TITLE) AS TITLE         ,UFN_FORMAT(A.CRDT,'DATE') AS CRDT		-- INDIVIDUAL,		-- SINGLEPUB,         ,MAX (A.E_MAIL) AS E_MAIL         ,SUM (WONAMT) AS BILL_AMT         ,SUM (VAT) AS BILL_VAT         ,MAX (F.SSALESNM) AS SSALESNM         ,SUM (WONAMT) + SUM (VAT) AS TOT_AMT         ,MAX(CASE WHEN NVL(BANK_YN,'N') = 'N'		           THEN 'No'		           ELSE 'Yes'		           END) AS BANK_YN         ,MAX(CASE WHEN BANK_DAY IS NULL		           THEN ''		           ELSE BANK_DAY || '일'		           END) AS BANK_DAY		    ,MAX(X.E_MAIL) AS EMAIL    FROM AC_TAX@DL_YJITEXP A,         AC_TAX_BODY@DL_YJITEXP  B,         CO_CUSTOMER@DL_YJITEXP  C,         CO_DEPT@DL_YJITEXP  D,         CO_PROJECT@DL_YJITEXP  E,         CO_SALES@DL_YJITEXP  F,         CRM_CUST_MST X   WHERE     A.PRTGB = 'P'         AND A.CRDT LIKE '@CRMM%'          AND A.TAXNO = B.TAXNO         AND B.PRT = 'P'         AND A.CUST = C.CODE(+)         AND A.BUCD = D.DEPT(+)         AND A.PRJCD = E.RFNO(+)         AND C.SALESCD = F.SSALESCD(+)         AND A.CUST = X.CUST_CD(+)	   [COCD]	    AND A.CUST = TRIM('@COCD')	   [/COCD]	   [DEPTCD]	    AND A.BUCD = TRIM('@DEPTCD')	   [/DEPTCD]	   [SALESCD]	    AND C.SALESCD = TRIM('@SALESCD')	   [/SALESCD]	   [PRJCD]	    AND A.PRJCD = '@PRJCD'	   [/PRJCD]GROUP BY A.TAXNO,         A.CUST,         A.CUSTNM,         A.CRDT 	--	 INDIVIDUAL,		-- SINGLEPUBORDER BY A.CUSTNM,         A.CRDT,         A.CUST,         A.TAXNO         /*SELECT A.TAXNO,         A.CUST,         A.CUSTNM,         MAX (A.REGNO) AS REGNO,         MAX (A.ADDR) AS ADDR,         A.CUSTNM,         MAX (C.CTRT_STRT_YMD) AS CTRT_STRT_YMD,         MAX (D.DEPTNM) AS DEPTNM,         MAX (E.TITLE) AS TITLE,         A.CRDT,         MAX (A.E_MAIL) AS E_MAIL,         SUM (WONAMT) AS BILL_AMT,         SUM (VAT) AS BILL_VAT,         MAX (F.SSALESNM) AS SSALESNM,		 MAX(BILL_AMT+BILL_VAT) AS TOT_AMT    FROM AC_TAX @DL_YJITEXP A,         AC_TAX_BODY@DL_YJITEXP B,         CO_CUSTOMER@DL_YJITEXP C,         CO_DEPT@DL_YJITEXP D,         CO_PROJECT@DL_YJITEXP E,         CO_SALES@DL_YJITEXP F   WHERE  A.CUST = C.CODE(+)         AND A.BUCD = D.DEPT(+)         AND A.PRJCD = E.RFNO(+)         AND C.SALESCD = F.SSALESCD(+)          AND A.TAXNO = B.TAXNO           AND A.PRTGB = 'P'         AND A.CRDT LIKE '@CRMM%' 	   [COCD]	    AND A.CUST = TRIM('@COCD')	   [/COCD]	   [DEPTCD]	    AND A.DEPTCD = TRIM('@DEPTCD')	   [/DEPTCD]	   [SALESCD]	    AND B.SALESCD = TRIM('@SALESCD')	   [/SALESCD]	   [PRJCD]	    AND A.PRJCD = '@PRJCD'	   [/PRJCD]GROUP BY A.TAXNO,         A.CUST,         A.CUSTNM,         A.CRDTORDER BY A.CUSTNM,         A.CRDT,         A.CUST,         A.TAXNO*/
#CrmTaxMgt@SearchDiff
--CrmTaxMgt@SearchDiff   WITH COMPARE AS (			  SELECT  A.TAXNO         ,TRIM(A.CUST) AS CUST         ,A.CUSTNM AS NAME2         ,UFN_FORMAT(TRIM(MAX (A.REGNO)),'CRN') AS REGNO         ,MAX (A.ADDR) AS ADDR         ,A.CUSTNM          ,UFN_FORMAT(MAX (C.CTRT_STRT_YMD),'DATE') AS CTRT_STRT_YMD         ,MAX (D.DEPTNM) AS DEPTNM         ,MAX (E.TITLE) AS TITLE         ,UFN_FORMAT(A.CRDT,'DATE') AS CRDT		-- INDIVIDUAL,		-- SINGLEPUB,         ,MAX (A.E_MAIL) AS E_MAIL         ,SUM (WONAMT) AS BILL_AMT         ,SUM (VAT) AS BILL_VAT         ,MAX (F.SSALESNM) AS SSALESNM         ,SUM (WONAMT) + SUM (VAT) AS TOT_AMT         ,MAX(CASE WHEN NVL(BANK_YN,'N') = 'N'		           THEN 'No'		           ELSE 'Yes'		           END) AS BANK_YN         ,MAX(CASE WHEN BANK_DAY IS NULL		           THEN ''		           ELSE BANK_DAY || '일'		           END) AS BANK_DAY		    ,MAX(X.E_MAIL) AS EMAIL    FROM AC_TAX@DL_YJITEXP A,         AC_TAX_BODY@DL_YJITEXP  B,         CO_CUSTOMER@DL_YJITEXP  C,         CO_DEPT@DL_YJITEXP  D,         CO_PROJECT@DL_YJITEXP  E,         CO_SALES@DL_YJITEXP  F,         CRM_CUST_MST X   WHERE     A.PRTGB = 'P'         AND A.CRDT LIKE '@CRMM%'          AND A.TAXNO = B.TAXNO         AND B.PRT = 'P'         AND A.CUST = C.CODE(+)         AND A.BUCD = D.DEPT(+)         AND A.PRJCD = E.RFNO(+)         AND C.SALESCD = F.SSALESCD(+)         AND A.CUST = X.CUST_CD(+)	   [COCD]	    AND A.CUST = TRIM('@COCD')	   [/COCD]	   [DEPTCD]	    AND A.BUCD = TRIM('@DEPTCD')	   [/DEPTCD]	   [SALESCD]	    AND C.SALESCD = TRIM('@SALESCD')	   [/SALESCD]	   [PRJCD]	    AND A.PRJCD = '@PRJCD'	   [/PRJCD]GROUP BY A.TAXNO,         A.CUST,         A.CUSTNM,         A.CRDT  ORDER BY A.CUSTNM,         A.CRDT,         A.CUST,         A.TAXNO         ),EXPECTED  AS ( 			SELECT  TRIM(A.CUST) AS CUST		    ,B.NAME2		    ,MAX(B.REGNO) AS REGNO		    ,MAX('') AS TAXADR		    ,UFN_FORMAT(MAX(B.CTRT_STRT_YMD),'DATE') AS CTRT_STRT_YMD		    ,MAX(C.DEPTNM) AS DEPTNM		    ,MAX(D.TITLE) AS TITLE		    ,INDIVIDUAL		    ,SINGLEPUB		    --,UFN_FORMAT(A.TAXDD,'DATE') AS TAXDD		    ,A.TAXDD		    ,SUM(BILL_AMT) AS BILL_AMT		    ,SUM(BILL_VAT) AS BILL_VAT		    ,MAX(SSALESNM) AS SSALESNM		    ,MAX(A.MODIFYGB) AS MODIFYGB		    ,MAX(A.RMK) AS RMK  		    ,'@CRMM' || A.TAXDD AS ISSUE_YMD		    ,MAX(BILL_AMT+BILL_VAT) AS TOT_AMT		    ,MAX(CASE WHEN NVL(BANK_YN,'N') = 'N'		          THEN 'No'		          ELSE 'Yes'		          END) AS BANK_YN		    ,MAX(CASE WHEN BANK_DAY IS NULL		              THEN ''		              ELSE BANK_DAY || '일'		              END) AS BANK_DAY		    ,MAX(X.E_MAIL) AS EMAIL            ,''  AS CRDT      FROM AC_CODE3@DL_YJITEXP A           ,CO_CUSTOMER@DL_YJITEXP B           ,CO_DEPT@DL_YJITEXP C           ,CO_PROJECT@DL_YJITEXP D           ,CO_SALES@DL_YJITEXP E            ,CRM_CUST_MST C           ,CO_CUST2@DL_YJITEXP X      WHERE ((A.SINGLEPUB = 'N' 	    AND A.SDATE < '@CRMM' || '32') 	     OR (A.SINGLEPUB = 'Y' 	          AND A.SDATE >= '@CRMM' || '01' 	          AND A.SDATE < '@CRMM' || '32'))  	    AND A.DEPTCD = C.DEPT(+)	    AND A.PRJCD = D.RFNO(+) 	    AND B.SALESCD = E.SSALESCD(+)	    AND A.CUST = B.CODE(+) 	    AND A.CUST = C.CUST_CD(+) 	    AND A.CUST = X.CODE(+) 	    AND X.TASEQ = '01'	    [MODIFYGB]	    AND A.MODIFYGB = '@MODIFYGB'	    [/MODIFYGB]	    [COCD]	    AND A.CUST = TRIM('@COCD')	    [/COCD]	    [DEPTCD]	    AND A.DEPTCD = TRIM('@DEPTCD')	    [/DEPTCD]	    [SALESCD]	    AND B.SALESCD = TRIM('@SALESCD')	    [/SALESCD]	    [PRJCD]	    AND A.PRJCD = '@PRJCD'	    [/PRJCD]	    GROUP BY A.CUST,B.NAME2,INDIVIDUAL,SINGLEPUB,A.TAXDD 	    ORDER BY B.NAME2,A.TAXDD,A.CUST,INDIVIDUAL,SINGLEPUB   )  SELECT /* C.CUST         ,C.NAME2         ,C.REGNO         ,C.TAXADR         ,C.CTRT_STRT_YMD         ,C.DEPTNM         ,C.TITLE         ,C.INDIVIDUAL         ,C.SINGLEPUB          ,C.TAXDD         ,C.BILL_AMT         ,C.BILL_VAT         ,C.SSALESNM         ,C.MODIFYGB         ,C.RMK           ,C.ISSUE_YMD         ,C.TOT_AMT         ,C.BANK_YN         ,C.BANK_DAY         ,C.EMAIL         ,'차이' AS STATUS          ,C.CRDT AS CRDT*/                  C.CUST         ,C.NAME2         ,C.REGNO         ,'' AS TAXADR         ,C.CTRT_STRT_YMD         ,C.DEPTNM         ,C.TITLE         ,'' AS INDIVIDUAL         ,'' AS SINGLEPUB          ,'' AS TAXDD         ,C.BILL_AMT         ,C.BILL_VAT         ,C.SSALESNM         ,'' AS MODIFYGB         ,'' AS RMK           ,C.CRDT AS ISSUE_YMD         ,C.TOT_AMT         ,C.BANK_YN         ,C.BANK_DAY         ,C.EMAIL         ,'차이' AS STATUS          ,C.CRDT AS CRDT  FROM EXPECTED E  , COMPARE C    WHERE C.TOT_AMT <> E.TOT_AMT   AND E.CUST = C.CUSTUNION ALL   SELECT /*  C.CUST         ,C.NAME2         ,C.REGNO         ,C.TAXADR         ,C.CTRT_STRT_YMD         ,C.DEPTNM         ,C.TITLE         ,C.INDIVIDUAL         ,C.SINGLEPUB          ,C.TAXDD         ,C.BILL_AMT         ,C.BILL_VAT         ,C.SSALESNM         ,C.MODIFYGB         ,C.RMK           ,'' AS ISSUE_YMD         ,C.TOT_AMT         ,C.BANK_YN         ,C.BANK_DAY         ,C.EMAIL*/           C.CUST         ,C.NAME2         ,C.REGNO         ,'' AS TAXADR         ,C.CTRT_STRT_YMD         ,C.DEPTNM         ,C.TITLE         ,'' AS INDIVIDUAL         ,'' AS SINGLEPUB          ,'' AS TAXDD         ,C.BILL_AMT         ,C.BILL_VAT         ,C.SSALESNM         ,'' AS MODIFYGB         ,'' AS RMK           ,C.CRDT AS ISSUE_YMD         ,C.TOT_AMT         ,C.BANK_YN         ,C.BANK_DAY         ,C.EMAIL         , '누락'  AS STATUS          ,C.CRDT AS CRDT   FROM  COMPARE C  WHERE C.CUST NOT IN ( SELECT E.CUST FROM EXPECTED E ) UNION ALL   SELECT /*  E.CUST        ,E.NAME2        ,E.REGNO        ,'' AS TAXADR        ,E.CTRT_STRT_YMD        ,E.DEPTNM        ,E.TITLE        ,'' AS INDIVIDUAL        ,'' AS SINGLEPUB         ,'' AS TAXDD        ,E.BILL_AMT        ,E.BILL_VAT        ,E.SSALESNM        ,'' AS MODIFYGB        ,'' AS RMK          ,'' AS ISSUE_YMD        ,E.TOT_AMT        ,E.BANK_YN        ,E.BANK_DAY        ,E.EMAIL*/          E.CUST         ,E.NAME2         ,E.REGNO         ,E.TAXADR         ,E.CTRT_STRT_YMD         ,E.DEPTNM         ,E.TITLE         ,E.INDIVIDUAL         ,E.SINGLEPUB          ,E.TAXDD         ,E.BILL_AMT         ,E.BILL_VAT         ,E.SSALESNM         ,E.MODIFYGB         ,E.RMK           ,'' AS ISSUE_YMD         ,E.TOT_AMT         ,E.BANK_YN         ,E.BANK_DAY         ,E.EMAIL         , '신규'  AS STATUS          ,E.CRDT   FROM EXPECTED E  WHERE E.CUST NOT IN ( SELECT C.CUST FROM COMPARE C  )
#CrmTaxMgt@SearchExpected
--CrmTaxMgt@SearchExpected --예상         SELECT  A.CUST		    ,B.NAME2		    ,MAX(B.REGNO) AS REGNO		    ,MAX('') AS TAXADR		    ,UFN_FORMAT(MAX(B.CTRT_STRT_YMD),'DATE') AS CTRT_STRT_YMD		    ,MAX(C.DEPTNM) AS DEPTNM		    ,MAX(D.TITLE) AS TITLE		    ,INDIVIDUAL		    ,SINGLEPUB		    --,UFN_FORMAT(A.TAXDD,'DATE') AS TAXDD		    ,A.TAXDD		    ,SUM(BILL_AMT) AS BILL_AMT		    ,SUM(BILL_VAT) AS BILL_VAT		    ,MAX(SSALESNM) AS SSALESNM		    ,MAX(A.MODIFYGB) AS MODIFYGB		    ,MAX(A.RMK) AS RMK  		    ,'@CRMM' || A.TAXDD AS ISSUE_YMD		    ,MAX(BILL_AMT+BILL_VAT) AS TOT_AMT		    ,MAX(CASE WHEN NVL(BANK_YN,'N') = 'N'		          THEN 'No'		          ELSE 'Yes'		          END) AS BANK_YN		    ,MAX(CASE WHEN BANK_DAY IS NULL		              THEN ''		              ELSE BANK_DAY || '일'		              END) AS BANK_DAY		    ,MAX(X.E_MAIL) AS EMAIL      FROM AC_CODE3@DL_YJITEXP A           ,CO_CUSTOMER@DL_YJITEXP B           ,CO_DEPT@DL_YJITEXP C           ,CO_PROJECT@DL_YJITEXP D           ,CO_SALES@DL_YJITEXP E            ,CRM_CUST_MST C           ,CO_CUST2@DL_YJITEXP X      WHERE ((A.SINGLEPUB = 'N' 	    AND A.SDATE < '@CRMM' || '32') 	     OR (A.SINGLEPUB = 'Y' 	          AND A.SDATE >= '@CRMM' || '01' 	          AND A.SDATE < '@CRMM' || '32'))  	    AND A.DEPTCD = C.DEPT(+)	    AND A.PRJCD = D.RFNO(+) 	    AND B.SALESCD = E.SSALESCD(+)	    AND A.CUST = B.CODE(+) 	    AND A.CUST = C.CUST_CD(+) 	    AND A.CUST = X.CODE(+) 	    AND X.TASEQ = '01'	    [MODIFYGB]	    AND A.MODIFYGB = '@MODIFYGB'	    [/MODIFYGB]	    [COCD]	    AND A.CUST = TRIM('@COCD')	    [/COCD]	    [DEPTCD]	    AND A.DEPTCD = TRIM('@DEPTCD')	    [/DEPTCD]	    [SALESCD]	    AND B.SALESCD = TRIM('@SALESCD')	    [/SALESCD]	    [PRJCD]	    AND A.PRJCD = '@PRJCD'	    [/PRJCD]	    GROUP BY A.CUST,B.NAME2,INDIVIDUAL,SINGLEPUB,A.TAXDD 	    ORDER BY B.NAME2,A.TAXDD,A.CUST,INDIVIDUAL,SINGLEPUB   
